---
title: Introduzione a PLINQ
ms.date: 03/30/2017
ms.technology: dotnet-standard
dev_langs:
- csharp
- vb
helpviewer_keywords:
- PLINQ queries, introduction to
ms.assetid: eaa720d8-8999-4eb7-8df5-3c19ca61cad0
ms.openlocfilehash: ed1b2df57c118a0ebb6b5ffa4326b3e2eac81dec
ms.sourcegitcommit: 7bc6887ab658550baa78f1520ea735838249345e
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/03/2020
ms.locfileid: "75632363"
---
# <a name="introduction-to-plinq"></a><span data-ttu-id="1e399-102">Introduzione a PLINQ</span><span class="sxs-lookup"><span data-stu-id="1e399-102">Introduction to PLINQ</span></span>

## <a name="what-is-a-parallel-query"></a><span data-ttu-id="1e399-103">Che cos'è una query parallela?</span><span class="sxs-lookup"><span data-stu-id="1e399-103">What is a Parallel Query?</span></span>

<span data-ttu-id="1e399-104">LINQ (Language-Integrated Query), introdotto in .NET Framework 3.5,</span><span class="sxs-lookup"><span data-stu-id="1e399-104">Language-Integrated Query (LINQ) was introduced in the .NET Framework 3.5.</span></span> <span data-ttu-id="1e399-105">offre un modello unificato per l'esecuzione di query su qualsiasi origine dati <xref:System.Collections.IEnumerable?displayProperty=nameWithType> o <xref:System.Collections.Generic.IEnumerable%601?displayProperty=nameWithType> in modo indipendente dai tipi.</span><span class="sxs-lookup"><span data-stu-id="1e399-105">It features a unified model for querying any <xref:System.Collections.IEnumerable?displayProperty=nameWithType> or <xref:System.Collections.Generic.IEnumerable%601?displayProperty=nameWithType> data source in a type-safe manner.</span></span> <span data-ttu-id="1e399-106">LINQ to Objects è il nome delle query LINQ eseguite su raccolte in memoria, ad esempio oggetti <xref:System.Collections.Generic.List%601> e matrici.</span><span class="sxs-lookup"><span data-stu-id="1e399-106">LINQ to Objects is the name for LINQ queries that are run against in-memory collections such as <xref:System.Collections.Generic.List%601> and arrays.</span></span> <span data-ttu-id="1e399-107">Questo articolo presuppone che si abbia già una conoscenza delle nozioni di base di LINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-107">This article assumes that you have a basic understanding of LINQ.</span></span> <span data-ttu-id="1e399-108">Per altre informazioni, vedere [LINQ (Language-Integrated Query)- C# ](../../csharp/programming-guide/concepts/linq/index.md) oppure [LINQ (Language-Integrated Query) - Visual Basic](../../visual-basic/programming-guide/concepts/linq/index.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-108">For more information, see [Language-Integrated Query (LINQ) - C#](../../csharp/programming-guide/concepts/linq/index.md) or [Language-Integrated Query (LINQ) - Visual Basic](../../visual-basic/programming-guide/concepts/linq/index.md).</span></span>

<span data-ttu-id="1e399-109">Parallel LINQ (PLINQ) è un'implementazione in parallelo del modello LINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-109">Parallel LINQ (PLINQ) is a parallel implementation of the LINQ pattern.</span></span> <span data-ttu-id="1e399-110">Una query PLINQ è molto simile a una query LINQ to Objects non parallela.</span><span class="sxs-lookup"><span data-stu-id="1e399-110">A PLINQ query in many ways resembles a non-parallel LINQ to Objects query.</span></span> <span data-ttu-id="1e399-111">Le query PLINQ, esattamente come le query LINQ sequenziali, operano su qualsiasi <xref:System.Collections.IEnumerable> in memoria o <xref:System.Collections.Generic.IEnumerable%601> origine dati e hanno un'esecuzione posticipata, ovvero non iniziano l'esecuzione fino a quando la query non viene enumerata.</span><span class="sxs-lookup"><span data-stu-id="1e399-111">PLINQ queries, just like sequential LINQ queries, operate on any in-memory <xref:System.Collections.IEnumerable> or <xref:System.Collections.Generic.IEnumerable%601> data source, and have deferred execution, which means they do not begin executing until the query is enumerated.</span></span> <span data-ttu-id="1e399-112">La differenza principale consiste nel fatto che PLINQ tenta di sfruttare al massimo tutti i processori del sistema.</span><span class="sxs-lookup"><span data-stu-id="1e399-112">The primary difference is that PLINQ attempts to make full use of all the processors on the system.</span></span> <span data-ttu-id="1e399-113">A tale scopo esegue il partizionamento dell'origine dati in segmenti e quindi esegue la query su ogni segmento in thread di lavoro distinti e in parallelo su più processori.</span><span class="sxs-lookup"><span data-stu-id="1e399-113">It does this by partitioning the data source into segments, and then executing the query on each segment on separate worker threads in parallel on multiple processors.</span></span> <span data-ttu-id="1e399-114">In molti casi, l'esecuzione parallela rende notevolmente più rapida l'esecuzione della query.</span><span class="sxs-lookup"><span data-stu-id="1e399-114">In many cases, parallel execution means that the query runs significantly faster.</span></span>

<span data-ttu-id="1e399-115">Tramite l'esecuzione parallela, PLINQ può garantire per determinati tipi di query prestazioni significativamente migliori rispetto al codice legacy, spesso con la sola aggiunta dell'operazione di query <xref:System.Linq.ParallelEnumerable.AsParallel%2A> all'origine dati.</span><span class="sxs-lookup"><span data-stu-id="1e399-115">Through parallel execution, PLINQ can achieve significant performance improvements over legacy code for certain kinds of queries, often just by adding the <xref:System.Linq.ParallelEnumerable.AsParallel%2A> query operation to the data source.</span></span> <span data-ttu-id="1e399-116">Tuttavia, il parallelismo può introdurre complessità intrinseche e non tutte le operazioni di query presentano un'esecuzione più veloce in PLINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-116">However, parallelism can introduce its own complexities, and not all query operations run faster in PLINQ.</span></span> <span data-ttu-id="1e399-117">Di fatto, per determinate query la parallelizzazione comporta un'esecuzione più lenta.</span><span class="sxs-lookup"><span data-stu-id="1e399-117">In fact, parallelization actually slows down certain queries.</span></span> <span data-ttu-id="1e399-118">È pertanto necessario comprendere il modo in cui alcuni aspetti, ad esempio l'ordinamento, influiscono sulle query parallele.</span><span class="sxs-lookup"><span data-stu-id="1e399-118">Therefore, you should understand how issues such as ordering affect parallel queries.</span></span> <span data-ttu-id="1e399-119">Per altre informazioni, vedere [Informazioni sull'aumento di velocità in PLINQ](../../../docs/standard/parallel-programming/understanding-speedup-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-119">For more information, see [Understanding Speedup in PLINQ](../../../docs/standard/parallel-programming/understanding-speedup-in-plinq.md).</span></span>

> [!NOTE]
> <span data-ttu-id="1e399-120">Le espressioni lambda sono usate nella documentazione per definire i delegati in PLINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-120">This documentation uses lambda expressions to define delegates in PLINQ.</span></span> <span data-ttu-id="1e399-121">Se non si ha familiarità con le espressioni lambda in C# o Visual Basic, vedere [Espressioni lambda in PLINQ e TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-121">If you are not familiar with lambda expressions in C# or Visual Basic, see [Lambda Expressions in PLINQ and TPL](../../../docs/standard/parallel-programming/lambda-expressions-in-plinq-and-tpl.md).</span></span>

<span data-ttu-id="1e399-122">La parte rimanente di questo articolo offre una panoramica delle classi PLINQ principali e descrive come creare query PLINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-122">The remainder of this article gives an overview of the main PLINQ classes, and discusses how to create PLINQ queries.</span></span> <span data-ttu-id="1e399-123">Ogni sezione contiene collegamenti a informazioni dettagliate ed esempi di codice.</span><span class="sxs-lookup"><span data-stu-id="1e399-123">Each section contains links to more detailed information and code examples.</span></span>

## <a name="the-parallelenumerable-class"></a><span data-ttu-id="1e399-124">Classe ParallelEnumerable</span><span class="sxs-lookup"><span data-stu-id="1e399-124">The ParallelEnumerable Class</span></span>

<span data-ttu-id="1e399-125">La classe <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> espone quasi tutte le funzionalità di PLINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-125">The <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> class exposes almost all of PLINQ's functionality.</span></span> <span data-ttu-id="1e399-126">Questa classe e gli altri tipi dello spazio dei nomi <xref:System.Linq?displayProperty=nameWithType> vengono compilati nell'assembly System.Core.dll.</span><span class="sxs-lookup"><span data-stu-id="1e399-126">It and the rest of the <xref:System.Linq?displayProperty=nameWithType> namespace types are compiled into the System.Core.dll assembly.</span></span> <span data-ttu-id="1e399-127">In Visual Studio i progetti C# e Visual Basic predefiniti fanno riferimento all'assembly e importano lo spazio dei nomi.</span><span class="sxs-lookup"><span data-stu-id="1e399-127">The default C# and Visual Basic projects in Visual Studio both reference the assembly and import the namespace.</span></span>

<span data-ttu-id="1e399-128"><xref:System.Linq.ParallelEnumerable> include le implementazioni di tutti gli operatori query standard supportati da LINQ to Objects, anche se non tenta di parallelizzare ognuno di essi.</span><span class="sxs-lookup"><span data-stu-id="1e399-128"><xref:System.Linq.ParallelEnumerable> includes implementations of all the standard query operators that LINQ to Objects supports, although it does not attempt to parallelize each one.</span></span> <span data-ttu-id="1e399-129">Se non si ha familiarità con LINQ, vedere [Introduzione a LINQC#()](../../csharp/programming-guide/concepts/linq/index.md) e [Introduzione a LINQ (Visual Basic)](../../visual-basic/programming-guide/concepts/linq/introduction-to-linq.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-129">If you are not familiar with LINQ, see [Introduction to LINQ (C#)](../../csharp/programming-guide/concepts/linq/index.md) and [Introduction to LINQ (Visual Basic)](../../visual-basic/programming-guide/concepts/linq/introduction-to-linq.md).</span></span>

<span data-ttu-id="1e399-130">Oltre agli operatori query standard, la classe <xref:System.Linq.ParallelEnumerable> contiene un set di metodi che rendono possibili comportamenti specifici dell'esecuzione parallela.</span><span class="sxs-lookup"><span data-stu-id="1e399-130">In addition to the standard query operators, the <xref:System.Linq.ParallelEnumerable> class contains a set of methods that enable behaviors specific to parallel execution.</span></span> <span data-ttu-id="1e399-131">Questi metodi specifici di PLINQ sono elencati nella tabella seguente.</span><span class="sxs-lookup"><span data-stu-id="1e399-131">These PLINQ-specific methods are listed in the following table.</span></span>

|<span data-ttu-id="1e399-132">Operatore ParallelEnumerable</span><span class="sxs-lookup"><span data-stu-id="1e399-132">ParallelEnumerable Operator</span></span>|<span data-ttu-id="1e399-133">Descrizione</span><span class="sxs-lookup"><span data-stu-id="1e399-133">Description</span></span>|
|---------------------------------|-----------------|
|<xref:System.Linq.ParallelEnumerable.AsParallel%2A>|<span data-ttu-id="1e399-134">Punto di ingresso di PLINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-134">The entry point for PLINQ.</span></span> <span data-ttu-id="1e399-135">Specifica che la parte rimanente della query deve essere parallelizzata, se è possibile.</span><span class="sxs-lookup"><span data-stu-id="1e399-135">Specifies that the rest of the query should be parallelized, if it is possible.</span></span>|
|<xref:System.Linq.ParallelEnumerable.AsSequential%2A>|<span data-ttu-id="1e399-136">Specifica che la parte rimanente della query deve essere eseguita in sequenza, come una query LINQ non parallela.</span><span class="sxs-lookup"><span data-stu-id="1e399-136">Specifies that the rest of the query should be run sequentially, as a non-parallel LINQ query.</span></span>|
|<xref:System.Linq.ParallelEnumerable.AsOrdered%2A>|<span data-ttu-id="1e399-137">Specifica che PLINQ deve conservare l'ordine della sequenza di origine per la parte rimanente della query oppure fino a quando l'ordine non viene modificato, ad esempio tramite la clausola orderby (Order By in Visual Basic).</span><span class="sxs-lookup"><span data-stu-id="1e399-137">Specifies that PLINQ should preserve the ordering of the source sequence for the rest of the query, or until the ordering is changed, for example by the use of an orderby (Order By in Visual Basic) clause.</span></span>|
|<xref:System.Linq.ParallelEnumerable.AsUnordered%2A>|<span data-ttu-id="1e399-138">Specifica che non è necessario che PLINQ conservi l'ordine della sequenza di origine per la parte rimanente della query.</span><span class="sxs-lookup"><span data-stu-id="1e399-138">Specifies that PLINQ for the rest of the query is not required to preserve the ordering of the source sequence.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithCancellation%2A>|<span data-ttu-id="1e399-139">Specifica che PLINQ deve monitorare periodicamente lo stato del token di annullamento specificato e, se richiesto, annullare l'esecuzione.</span><span class="sxs-lookup"><span data-stu-id="1e399-139">Specifies that PLINQ should periodically monitor the state of the provided cancellation token and cancel execution if it is requested.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithDegreeOfParallelism%2A>|<span data-ttu-id="1e399-140">Specifica il numero massimo di processori che PLINQ deve usare per parallelizzare la query.</span><span class="sxs-lookup"><span data-stu-id="1e399-140">Specifies the maximum number of processors that PLINQ should use to parallelize the query.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A>|<span data-ttu-id="1e399-141">Offre un suggerimento su come PLINQ deve unire, se possibile, i risultati paralleli in un'unica sequenza nel thread in uso.</span><span class="sxs-lookup"><span data-stu-id="1e399-141">Provides a hint about how PLINQ should, if it is possible, merge parallel results back into just one sequence on the consuming thread.</span></span>|
|<xref:System.Linq.ParallelEnumerable.WithExecutionMode%2A>|<span data-ttu-id="1e399-142">Specifica se PLINQ deve parallelizzare la query anche quando il comportamento predefinito ne prevede l'esecuzione sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-142">Specifies whether PLINQ should parallelize the query even when the default behavior would be to run it sequentially.</span></span>|
|<xref:System.Linq.ParallelEnumerable.ForAll%2A>|<span data-ttu-id="1e399-143">Metodo di enumerazione multithreading che, a differenza dell'iterazione sui risultati della query, consente ai risultati di essere elaborati in parallelo senza prima essere uniti nel thread in uso.</span><span class="sxs-lookup"><span data-stu-id="1e399-143">A multithreaded enumeration method that, unlike iterating over the results of the query, enables results to be processed in parallel without first merging back to the consumer thread.</span></span>|
|<span data-ttu-id="1e399-144">Overload <xref:System.Linq.ParallelEnumerable.Aggregate%2A></span><span class="sxs-lookup"><span data-stu-id="1e399-144"><xref:System.Linq.ParallelEnumerable.Aggregate%2A> overload</span></span>|<span data-ttu-id="1e399-145">Overload esclusivo di PLINQ che consente l'aggregazione intermedia su partizioni di thread locali e che offre una funzione di aggregazione finale per combinare i risultati di tutte le partizioni.</span><span class="sxs-lookup"><span data-stu-id="1e399-145">An overload that is unique to PLINQ and enables intermediate aggregation over thread-local partitions, plus a final aggregation function to combine the results of all partitions.</span></span>|

## <a name="the-opt-in-model"></a><span data-ttu-id="1e399-146">Modello basato su scelta esplicita</span><span class="sxs-lookup"><span data-stu-id="1e399-146">The Opt-in Model</span></span>

<span data-ttu-id="1e399-147">Quando si scrive una query è possibile scegliere esplicitamente PLINQ richiamando il metodo di estensione <xref:System.Linq.ParallelEnumerable.AsParallel%2A?displayProperty=nameWithType> nell'origine dati, come illustrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="1e399-147">When you write a query, opt in to PLINQ by invoking the <xref:System.Linq.ParallelEnumerable.AsParallel%2A?displayProperty=nameWithType> extension method on the data source, as shown in the following example.</span></span>

[!code-csharp[PLINQ#1](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#1)]
[!code-vb[PLINQ#1](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#1)]

<span data-ttu-id="1e399-148">Il metodo di estensione <xref:System.Linq.ParallelEnumerable.AsParallel%2A> associa gli operatori di query successivi, in questo caso `where` e `select`, alle implementazioni di <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="1e399-148">The <xref:System.Linq.ParallelEnumerable.AsParallel%2A> extension method binds the subsequent query operators, in this case, `where` and `select`, to the <xref:System.Linq.ParallelEnumerable?displayProperty=nameWithType> implementations.</span></span>

## <a name="execution-modes"></a><span data-ttu-id="1e399-149">Modalità di esecuzione</span><span class="sxs-lookup"><span data-stu-id="1e399-149">Execution Modes</span></span>

<span data-ttu-id="1e399-150">Per impostazione predefinita, PLINQ è conservativo.</span><span class="sxs-lookup"><span data-stu-id="1e399-150">By default, PLINQ is conservative.</span></span> <span data-ttu-id="1e399-151">Durante il runtime, l'infrastruttura PLINQ analizza la struttura complessiva della query.</span><span class="sxs-lookup"><span data-stu-id="1e399-151">At run time, the PLINQ infrastructure analyzes the overall structure of the query.</span></span> <span data-ttu-id="1e399-152">Se è probabile che la parallelizzazione della query comporti una maggiore velocità di esecuzione, PLINQ esegue il partizionamento della sequenza di origine in attività eseguibili simultaneamente.</span><span class="sxs-lookup"><span data-stu-id="1e399-152">If the query is likely to yield speedups by parallelization, PLINQ partitions the source sequence into tasks that can be run concurrently.</span></span> <span data-ttu-id="1e399-153">Se la parallelizzazione della query non risulta un'operazione sicura, PLINQ si limita ad eseguire la query in modo sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-153">If it is not safe to parallelize a query, PLINQ just runs the query sequentially.</span></span> <span data-ttu-id="1e399-154">Tra un algoritmo in parallelo potenzialmente dispendioso e un algoritmo sequenziale poco dispendioso, per impostazione predefinita PLINQ sceglie l'algoritmo sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-154">If PLINQ has a choice between a potentially expensive parallel algorithm or an inexpensive sequential algorithm, it chooses the sequential algorithm by default.</span></span> <span data-ttu-id="1e399-155">È possibile usare il metodo <xref:System.Linq.ParallelEnumerable.WithExecutionMode%2A> e l'enumerazione <xref:System.Linq.ParallelExecutionMode?displayProperty=nameWithType> per indicare a PLINQ di selezionare l'algoritmo parallelo.</span><span class="sxs-lookup"><span data-stu-id="1e399-155">You can use the <xref:System.Linq.ParallelEnumerable.WithExecutionMode%2A> method and the <xref:System.Linq.ParallelExecutionMode?displayProperty=nameWithType> enumeration to instruct PLINQ to select the parallel algorithm.</span></span> <span data-ttu-id="1e399-156">Ciò è utile quando si scopre tramite test e misurazioni che una determinata query risulta più veloce quando viene eseguita in parallelo.</span><span class="sxs-lookup"><span data-stu-id="1e399-156">This is useful when you know by testing and measurement that a particular query executes faster in parallel.</span></span> <span data-ttu-id="1e399-157">Per altre informazioni, vedere [Procedura: Specificare la modalità di esecuzione in PLINQ](../../../docs/standard/parallel-programming/how-to-specify-the-execution-mode-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-157">For more information, see [How to: Specify the Execution Mode in PLINQ](../../../docs/standard/parallel-programming/how-to-specify-the-execution-mode-in-plinq.md).</span></span>

## <a name="degree-of-parallelism"></a><span data-ttu-id="1e399-158">Grado di parallelismo</span><span class="sxs-lookup"><span data-stu-id="1e399-158">Degree of Parallelism</span></span>

<span data-ttu-id="1e399-159">Per impostazione predefinita, PLINQ usa tutti i processori nel computer host.</span><span class="sxs-lookup"><span data-stu-id="1e399-159">By default, PLINQ uses all of the processors on the host computer.</span></span> <span data-ttu-id="1e399-160">Usando il metodo <xref:System.Linq.ParallelEnumerable.WithDegreeOfParallelism%2A> è possibile indicare a PLINQ di usare un numero massimo di processori specificato.</span><span class="sxs-lookup"><span data-stu-id="1e399-160">You can instruct PLINQ to use no more than a specified number of processors by using the <xref:System.Linq.ParallelEnumerable.WithDegreeOfParallelism%2A> method.</span></span> <span data-ttu-id="1e399-161">Ciò è utile quando si vuole garantire che gli altri processi in esecuzione nel computer ricevano una determinata quantità di tempo CPU.</span><span class="sxs-lookup"><span data-stu-id="1e399-161">This is useful when you want to make sure that other processes running on the computer receive a certain amount of CPU time.</span></span> <span data-ttu-id="1e399-162">Il frammento seguente consente alla query di usare al massimo due processori.</span><span class="sxs-lookup"><span data-stu-id="1e399-162">The following snippet limits the query to utilizing a maximum of two processors.</span></span>

[!code-csharp[PLINQ#5](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinqsamples.cs#5)]
[!code-vb[PLINQ#5](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#5)]

<span data-ttu-id="1e399-163">Nei casi in cui una query stia eseguendo una quantità significativa di lavoro privo di vincoli di calcolo, ad esempio l'I/O dei file, può risultare vantaggioso specificare un grado di parallelismo maggiore del numero di core nel computer.</span><span class="sxs-lookup"><span data-stu-id="1e399-163">In cases where a query is performing a significant amount of non-compute-bound work such as File I/O, it might be beneficial to specify a degree of parallelism greater than the number of cores on the machine.</span></span>

## <a name="ordered-versus-unordered-parallel-queries"></a><span data-ttu-id="1e399-164">Confronto fra query parallele ordinate e non ordinate</span><span class="sxs-lookup"><span data-stu-id="1e399-164">Ordered Versus Unordered Parallel Queries</span></span>

<span data-ttu-id="1e399-165">In alcune query l'operatore di query deve produrre risultati che conservano l'ordine della sequenza di origine.</span><span class="sxs-lookup"><span data-stu-id="1e399-165">In some queries, a query operator must produce results that preserve the ordering of the source sequence.</span></span> <span data-ttu-id="1e399-166">A questo scopo, PLINQ fornisce l'operatore <xref:System.Linq.ParallelEnumerable.AsOrdered%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e399-166">PLINQ provides the <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> operator for this purpose.</span></span> <span data-ttu-id="1e399-167"><xref:System.Linq.ParallelEnumerable.AsOrdered%2A> si differenzia da <xref:System.Linq.ParallelEnumerable.AsSequential%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e399-167"><xref:System.Linq.ParallelEnumerable.AsOrdered%2A> is distinct from <xref:System.Linq.ParallelEnumerable.AsSequential%2A>.</span></span> <span data-ttu-id="1e399-168">Una sequenza <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> viene comunque elaborata in parallelo, ma i risultati vengono memorizzati nel buffer e ordinati.</span><span class="sxs-lookup"><span data-stu-id="1e399-168">An <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> sequence is still processed in parallel, but its results are buffered and sorted.</span></span> <span data-ttu-id="1e399-169">Poiché la conservazione dell'ordine comporta in genere un lavoro aggiuntivo, è possibile che una sequenza <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> venga elaborata più lentamente rispetto alla sequenza <xref:System.Linq.ParallelEnumerable.AsUnordered%2A> predefinita.</span><span class="sxs-lookup"><span data-stu-id="1e399-169">Because order preservation typically involves extra work, an <xref:System.Linq.ParallelEnumerable.AsOrdered%2A> sequence might be processed more slowly than the default <xref:System.Linq.ParallelEnumerable.AsUnordered%2A> sequence.</span></span> <span data-ttu-id="1e399-170">La possibilità che una determinata operazione in parallelo ordinata risulti più veloce di una versione sequenziale dell'operazione dipende da molti fattori.</span><span class="sxs-lookup"><span data-stu-id="1e399-170">Whether a particular ordered parallel operation is faster than a sequential version of the operation depends on many factors.</span></span>

<span data-ttu-id="1e399-171">L'esempio di codice seguente illustra come scegliere esplicitamente la conservazione dell'ordine.</span><span class="sxs-lookup"><span data-stu-id="1e399-171">The following code example shows how to opt in to order preservation.</span></span>

[!code-csharp[PLINQ#3](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#3)]
[!code-vb[PLINQ#3](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#3)]

<span data-ttu-id="1e399-172">Per altre informazioni, vedere [Conservazione dell'ordine in PLINQ](../../../docs/standard/parallel-programming/order-preservation-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-172">For more information, see [Order Preservation in PLINQ](../../../docs/standard/parallel-programming/order-preservation-in-plinq.md).</span></span>

## <a name="parallel-vs-sequential-queries"></a><span data-ttu-id="1e399-173">Query parallele e sequenziali</span><span class="sxs-lookup"><span data-stu-id="1e399-173">Parallel vs. Sequential Queries</span></span>

<span data-ttu-id="1e399-174">Alcune operazioni richiedono che i dati di origine vengano recapitati in modo sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-174">Some operations require that the source data be delivered in a sequential manner.</span></span> <span data-ttu-id="1e399-175">Quando è necessario, gli operatori di query <xref:System.Linq.ParallelEnumerable> ripristinano automaticamente la modalità sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-175">The <xref:System.Linq.ParallelEnumerable> query operators revert to sequential mode automatically when it is required.</span></span> <span data-ttu-id="1e399-176">Per gli operatori di query definiti dall'utente e i delegati dell'utente che richiedono l'esecuzione sequenziale, PLINQ fornisce il metodo <xref:System.Linq.ParallelEnumerable.AsSequential%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e399-176">For user-defined query operators and user delegates that require sequential execution, PLINQ provides the <xref:System.Linq.ParallelEnumerable.AsSequential%2A> method.</span></span> <span data-ttu-id="1e399-177">Quando si usa <xref:System.Linq.ParallelEnumerable.AsSequential%2A>, tutti gli operatori successivi nella query vengono eseguiti in sequenza fino a quando non viene richiamato il metodo <xref:System.Linq.ParallelEnumerable.AsParallel%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e399-177">When you use <xref:System.Linq.ParallelEnumerable.AsSequential%2A>, all subsequent operators in the query are executed sequentially until <xref:System.Linq.ParallelEnumerable.AsParallel%2A> is called again.</span></span> <span data-ttu-id="1e399-178">Per altre informazioni, vedere [Procedura: Combinare query LINQ parallele e sequenziali](../../../docs/standard/parallel-programming/how-to-combine-parallel-and-sequential-linq-queries.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-178">For more information, see [How to: Combine Parallel and Sequential LINQ Queries](../../../docs/standard/parallel-programming/how-to-combine-parallel-and-sequential-linq-queries.md).</span></span>

## <a name="options-for-merging-query-results"></a><span data-ttu-id="1e399-179">Opzioni di unione dei risultati di query</span><span class="sxs-lookup"><span data-stu-id="1e399-179">Options for Merging Query Results</span></span>

<span data-ttu-id="1e399-180">Quando una query PLINQ viene eseguita in parallelo, i relativi risultati ottenuti da ogni thread di lavoro devono essere uniti nel thread principale affinché vengano usati da un ciclo `foreach` (`For Each` in Visual Basic) o vengano inseriti in un elenco o in una matrice.</span><span class="sxs-lookup"><span data-stu-id="1e399-180">When a PLINQ query executes in parallel, its results from each worker thread must be merged back onto the main thread for consumption by a `foreach` loop (`For Each` in Visual Basic), or insertion into a list or array.</span></span> <span data-ttu-id="1e399-181">In alcuni casi può essere vantaggioso specificare un determinato tipo di operazione di unione, ad esempio per iniziare a produrre risultati più velocemente.</span><span class="sxs-lookup"><span data-stu-id="1e399-181">In some cases, it might be beneficial to specify a particular kind of merge operation, for example, to begin producing results more quickly.</span></span> <span data-ttu-id="1e399-182">A tale scopo, PLINQ supporta il metodo <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> e l'enumerazione <xref:System.Linq.ParallelMergeOptions>.</span><span class="sxs-lookup"><span data-stu-id="1e399-182">For this purpose, PLINQ supports the <xref:System.Linq.ParallelEnumerable.WithMergeOptions%2A> method, and the <xref:System.Linq.ParallelMergeOptions> enumeration.</span></span> <span data-ttu-id="1e399-183">Per altre informazioni, vedere [Opzioni di unione in PLINQ](../../../docs/standard/parallel-programming/merge-options-in-plinq.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-183">For more information, see [Merge Options in PLINQ](../../../docs/standard/parallel-programming/merge-options-in-plinq.md).</span></span>

## <a name="the-forall-operator"></a><span data-ttu-id="1e399-184">Operatore ForAll</span><span class="sxs-lookup"><span data-stu-id="1e399-184">The ForAll Operator</span></span>

<span data-ttu-id="1e399-185">Nelle query LINQ sequenziali l'esecuzione viene posticipata fino a quando la query non viene enumerata in un ciclo `foreach` (`For Each` in Visual Basic) o richiamando un metodo come <xref:System.Linq.ParallelEnumerable.ToList%2A>, <xref:System.Linq.ParallelEnumerable.ToArray%2A> o <xref:System.Linq.ParallelEnumerable.ToDictionary%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e399-185">In sequential LINQ queries, execution is deferred until the query is enumerated either in a `foreach` (`For Each` in Visual Basic) loop or by invoking a method such as <xref:System.Linq.ParallelEnumerable.ToList%2A> , <xref:System.Linq.ParallelEnumerable.ToArray%2A> , or <xref:System.Linq.ParallelEnumerable.ToDictionary%2A>.</span></span> <span data-ttu-id="1e399-186">In PLINQ è anche possibile usare `foreach` per eseguire la query e l'iterazione dei risultati.</span><span class="sxs-lookup"><span data-stu-id="1e399-186">In PLINQ, you can also use `foreach` to execute the query and iterate through the results.</span></span> <span data-ttu-id="1e399-187">Tuttavia, poiché non viene eseguito in parallelo, `foreach` richiede che l'output di tutte le attività in parallelo venga unito di nuovo nel thread in cui il ciclo è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="1e399-187">However, `foreach` itself does not run in parallel, and therefore, it requires that the output from all parallel tasks be merged back into the thread on which the loop is running.</span></span> <span data-ttu-id="1e399-188">In PLINQ è possibile usare `foreach` quando è necessario conservare l'ordine finale dei risultati della query nonché quando si elaborano i risultati in modo seriale, ad esempio quando si chiama `Console.WriteLine` per ogni elemento.</span><span class="sxs-lookup"><span data-stu-id="1e399-188">In PLINQ, you can use `foreach` when you must preserve the final ordering of the query results, and also whenever you are processing the results in a serial manner, for example when you are calling `Console.WriteLine` for each element.</span></span> <span data-ttu-id="1e399-189">Per eseguire più velocemente una query quando la conservazione dell'ordine non è richiesta e quando la stessa elaborazione dei risultati può essere parallelizzata, usare il metodo <xref:System.Linq.ParallelEnumerable.ForAll%2A> per eseguire una query PLINQ.</span><span class="sxs-lookup"><span data-stu-id="1e399-189">For faster query execution when order preservation is not required and when the processing of the results can itself be parallelized, use the <xref:System.Linq.ParallelEnumerable.ForAll%2A> method to execute a PLINQ query.</span></span> <span data-ttu-id="1e399-190"><xref:System.Linq.ParallelEnumerable.ForAll%2A> non esegue questo passaggio di merge finale.</span><span class="sxs-lookup"><span data-stu-id="1e399-190"><xref:System.Linq.ParallelEnumerable.ForAll%2A> does not perform this final merge step.</span></span> <span data-ttu-id="1e399-191">Nell'esempio di codice riportato di seguito viene illustrato come utilizzare il metodo <xref:System.Linq.ParallelEnumerable.ForAll%2A>.</span><span class="sxs-lookup"><span data-stu-id="1e399-191">The following code example shows how to use the <xref:System.Linq.ParallelEnumerable.ForAll%2A> method.</span></span> <span data-ttu-id="1e399-192">In questo caso viene usato l'oggetto <xref:System.Collections.Concurrent.ConcurrentBag%601?displayProperty=nameWithType> perché è ottimizzato per l'aggiunta simultanea di più thread senza un tentativo di rimuovere gli elementi.</span><span class="sxs-lookup"><span data-stu-id="1e399-192"><xref:System.Collections.Concurrent.ConcurrentBag%601?displayProperty=nameWithType> is used here because it is optimized for multiple threads adding concurrently without attempting to remove any items.</span></span>

[!code-csharp[PLINQ#4](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#4)]
[!code-vb[PLINQ#4](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq2_vb.vb#4)]

<span data-ttu-id="1e399-193">La figura seguente mostra la differenza tra `foreach` e <xref:System.Linq.ParallelEnumerable.ForAll%2A> per quanto riguarda l'esecuzione di query.</span><span class="sxs-lookup"><span data-stu-id="1e399-193">The following illustration shows the difference between `foreach` and <xref:System.Linq.ParallelEnumerable.ForAll%2A> with regard to query execution.</span></span>

<span data-ttu-id="1e399-194">![ForAll e ForEach](../../../docs/standard/parallel-programming/media/vs-isvnt-allvseach.png "VS_ISVNT_ALLvsEACH")</span><span class="sxs-lookup"><span data-stu-id="1e399-194">![ForAll vs. ForEach](../../../docs/standard/parallel-programming/media/vs-isvnt-allvseach.png "VS_ISVNT_ALLvsEACH")</span></span>

## <a name="cancellation"></a><span data-ttu-id="1e399-195">Annullamento</span><span class="sxs-lookup"><span data-stu-id="1e399-195">Cancellation</span></span>

<span data-ttu-id="1e399-196">PLINQ è integrato con i tipi di annullamento in .NET Framework 4.</span><span class="sxs-lookup"><span data-stu-id="1e399-196">PLINQ is integrated with the cancellation types in .NET Framework 4.</span></span> <span data-ttu-id="1e399-197">Per ulteriori informazioni, vedere [annullamento in thread gestiti](../../../docs/standard/threading/cancellation-in-managed-threads.md). Pertanto, a differenza delle query di LINQ to Objects sequenziali, le query PLINQ possono essere annullate.</span><span class="sxs-lookup"><span data-stu-id="1e399-197">(For more information, see [Cancellation in Managed Threads](../../../docs/standard/threading/cancellation-in-managed-threads.md).) Therefore, unlike sequential LINQ to Objects queries, PLINQ queries can be canceled.</span></span> <span data-ttu-id="1e399-198">Per creare una query PLINQ annullabile, usare l'operatore <xref:System.Linq.ParallelEnumerable.WithCancellation%2A> nella query e fornire un'istanza di <xref:System.Threading.CancellationToken> come argomento.</span><span class="sxs-lookup"><span data-stu-id="1e399-198">To create a cancelable PLINQ query, use the <xref:System.Linq.ParallelEnumerable.WithCancellation%2A> operator on the query and provide a <xref:System.Threading.CancellationToken> instance as the argument.</span></span> <span data-ttu-id="1e399-199">Quando la proprietà <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> nel token è impostata su true, PLINQ rileva questa impostazione, arresta l'elaborazione in tutti i thread e genera un'eccezione <xref:System.OperationCanceledException>.</span><span class="sxs-lookup"><span data-stu-id="1e399-199">When the <xref:System.Threading.CancellationToken.IsCancellationRequested%2A> property on the token is set to true, PLINQ will notice it, stop processing on all threads, and throw an <xref:System.OperationCanceledException>.</span></span>

<span data-ttu-id="1e399-200">È possibile che una query PLINQ continui a elaborare alcuni elementi dopo l'impostazione del token di annullamento.</span><span class="sxs-lookup"><span data-stu-id="1e399-200">It is possible that a PLINQ query might continue to process some elements after the cancellation token is set.</span></span>

<span data-ttu-id="1e399-201">Per garantire una maggiore capacità di risposta, è possibile rispondere alle richieste di annullamento anche nei delegati dell'utente di lunga durata.</span><span class="sxs-lookup"><span data-stu-id="1e399-201">For greater responsiveness, you can also respond to cancellation requests in long-running user delegates.</span></span> <span data-ttu-id="1e399-202">Per altre informazioni, vedere [Procedura: Annullare una query PLINQ](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-202">For more information, see [How to: Cancel a PLINQ Query](../../../docs/standard/parallel-programming/how-to-cancel-a-plinq-query.md).</span></span>

## <a name="exceptions"></a><span data-ttu-id="1e399-203">Eccezioni</span><span class="sxs-lookup"><span data-stu-id="1e399-203">Exceptions</span></span>

<span data-ttu-id="1e399-204">Quando viene eseguita una query PLINQ, è possibile che vengano generate simultaneamente più eccezioni da thread diversi.</span><span class="sxs-lookup"><span data-stu-id="1e399-204">When a PLINQ query executes, multiple exceptions might be thrown from different threads simultaneously.</span></span> <span data-ttu-id="1e399-205">Inoltre, il codice per gestire l'eccezione e quello che ha generato l'eccezione potrebbero trovarsi in thread diversi.</span><span class="sxs-lookup"><span data-stu-id="1e399-205">Also, the code to handle the exception might be on a different thread than the code that threw the exception.</span></span> <span data-ttu-id="1e399-206">PLINQ usa il tipo <xref:System.AggregateException> per incapsulare tutte le eccezioni generate da una query e quindi eseguirne il marshalling nel thread chiamante.</span><span class="sxs-lookup"><span data-stu-id="1e399-206">PLINQ uses the <xref:System.AggregateException> type to encapsulate all the exceptions that were thrown by a query, and marshal those exceptions back to the calling thread.</span></span> <span data-ttu-id="1e399-207">Nel thread chiamante è necessario un unico blocco try-catch.</span><span class="sxs-lookup"><span data-stu-id="1e399-207">On the calling thread, only one try-catch block is required.</span></span> <span data-ttu-id="1e399-208">È possibile tuttavia eseguire l'iterazione in tutte le eccezioni incapsulate in <xref:System.AggregateException> e rilevare quelle gestibili in modo sicuro.</span><span class="sxs-lookup"><span data-stu-id="1e399-208">However, you can iterate through all of the exceptions that are encapsulated in the <xref:System.AggregateException> and catch any that you can safely recover from.</span></span> <span data-ttu-id="1e399-209">In casi rari, alcune eccezioni possono essere generate senza wrapping in <xref:System.AggregateException>. Anche <xref:System.Threading.ThreadAbortException> non prevede il wrapping.</span><span class="sxs-lookup"><span data-stu-id="1e399-209">In rare cases, some exceptions may be thrown that are not wrapped in an <xref:System.AggregateException>, and <xref:System.Threading.ThreadAbortException>s  are also not wrapped.</span></span>

<span data-ttu-id="1e399-210">Quando alle eccezioni è consentita la propagazione fino al thread di unione, è possibile che una query continui a elaborare alcuni elementi dopo la generazione dell'eccezione.</span><span class="sxs-lookup"><span data-stu-id="1e399-210">When exceptions are allowed to bubble up back to the joining thread, then it is possible that a query may continue to process some items after the exception is raised.</span></span>

<span data-ttu-id="1e399-211">Per altre informazioni, vedere [Procedura: Gestire le eccezioni in una query PLINQ](../../../docs/standard/parallel-programming/how-to-handle-exceptions-in-a-plinq-query.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-211">For more information, see [How to: Handle Exceptions in a PLINQ Query](../../../docs/standard/parallel-programming/how-to-handle-exceptions-in-a-plinq-query.md).</span></span>

## <a name="custom-partitioners"></a><span data-ttu-id="1e399-212">Partitioner personalizzati</span><span class="sxs-lookup"><span data-stu-id="1e399-212">Custom Partitioners</span></span>

<span data-ttu-id="1e399-213">In alcuni casi è possibile migliorare le prestazioni delle query scrivendo un Partitioner personalizzato che sfrutta alcune caratteristiche dei dati di origine.</span><span class="sxs-lookup"><span data-stu-id="1e399-213">In some cases, you can improve query performance by writing a custom partitioner that takes advantage of some characteristic of the source data.</span></span> <span data-ttu-id="1e399-214">Nella query il partitioner personalizzato è l'oggetto enumerabile su cui viene eseguita la query.</span><span class="sxs-lookup"><span data-stu-id="1e399-214">In the query, the custom partitioner itself is the enumerable object that is queried.</span></span>

[!code-csharp[PLINQ#2](../../../samples/snippets/csharp/VS_Snippets_Misc/plinq/cs/plinq2_cs.cs#2)]
[!code-vb[PLINQ#2](../../../samples/snippets/visualbasic/VS_Snippets_Misc/plinq/vb/plinq3.vb#2)]

<span data-ttu-id="1e399-215">PLINQ supporta un numero fisso di partizioni. È tuttavia possibile che durante il runtime i dati vengano riassegnati dinamicamente alle partizioni per il bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="1e399-215">PLINQ supports a fixed number of partitions (although data may be dynamically reassigned to those partitions during run time for load balancing.).</span></span> <span data-ttu-id="1e399-216"><xref:System.Threading.Tasks.Parallel.For%2A> e <xref:System.Threading.Tasks.Parallel.ForEach%2A> supportano solo il partizionamento dinamico, il che significa che il numero di partizioni cambia in fase di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="1e399-216"><xref:System.Threading.Tasks.Parallel.For%2A> and <xref:System.Threading.Tasks.Parallel.ForEach%2A> support only dynamic partitioning, which means that the number of partitions changes at run time.</span></span> <span data-ttu-id="1e399-217">Per altre informazioni, vedere [Partitioner personalizzati per PLINQ e TPL](../../../docs/standard/parallel-programming/custom-partitioners-for-plinq-and-tpl.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-217">For more information, see [Custom Partitioners for PLINQ and TPL](../../../docs/standard/parallel-programming/custom-partitioners-for-plinq-and-tpl.md).</span></span>

## <a name="measuring-plinq-performance"></a><span data-ttu-id="1e399-218">Misurazione delle prestazioni di PLINQ</span><span class="sxs-lookup"><span data-stu-id="1e399-218">Measuring PLINQ Performance</span></span>

<span data-ttu-id="1e399-219">In molti casi una query può essere parallelizzata, ma le risorse necessarie per configurare la query parallela rappresentano uno svantaggio superiore al vantaggio ottenuto in termini di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="1e399-219">In many cases, a query can be parallelized, but the overhead of setting up the parallel query outweighs the performance benefit gained.</span></span> <span data-ttu-id="1e399-220">Se la query esegue pochi calcoli o se l'origine dati è di dimensioni ridotte, è possibile che una query PLINQ risulti più lenta di una query LINQ to Objects sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-220">If a query does not perform much computation or if the data source is small, a PLINQ query may be slower than a sequential LINQ to Objects query.</span></span> <span data-ttu-id="1e399-221">È possibile usare Parallel Performance Analyzer in Visual Studio Team Server per confrontare le prestazioni delle diverse query per individuare colli di bottiglia di elaborazione e determinare se la query è eseguita in parallelo o in modo sequenziale.</span><span class="sxs-lookup"><span data-stu-id="1e399-221">You can use the Parallel Performance Analyzer in Visual Studio Team Server to compare the performance of various queries, to locate processing bottlenecks, and to determine whether your query is running in parallel or sequentially.</span></span> <span data-ttu-id="1e399-222">Per altre informazioni, vedere [Visualizzatore di concorrenze](/visualstudio/profiling/concurrency-visualizer) e [Procedura: Misurare le prestazioni di esecuzione delle query di PLINQ](../../../docs/standard/parallel-programming/how-to-measure-plinq-query-performance.md).</span><span class="sxs-lookup"><span data-stu-id="1e399-222">For more information, see [Concurrency Visualizer](/visualstudio/profiling/concurrency-visualizer) and [How to: Measure PLINQ Query Performance](../../../docs/standard/parallel-programming/how-to-measure-plinq-query-performance.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="1e399-223">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="1e399-223">See also</span></span>

- [<span data-ttu-id="1e399-224">Parallel LINQ (PLINQ)</span><span class="sxs-lookup"><span data-stu-id="1e399-224">Parallel LINQ (PLINQ)</span></span>](../../../docs/standard/parallel-programming/parallel-linq-plinq.md)
- [<span data-ttu-id="1e399-225">Informazioni sull'aumento di velocità in PLINQ</span><span class="sxs-lookup"><span data-stu-id="1e399-225">Understanding Speedup in PLINQ</span></span>](../../../docs/standard/parallel-programming/understanding-speedup-in-plinq.md)
