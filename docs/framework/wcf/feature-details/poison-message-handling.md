---
title: Gestione dei messaggi non elaborabili
ms.date: 03/30/2017
ms.assetid: 8d1c5e5a-7928-4a80-95ed-d8da211b8595
ms.openlocfilehash: ff1eaec99308b06250722b290b7005ac21731570
ms.sourcegitcommit: 30a558d23e3ac5a52071121a52c305c85fe15726
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 12/25/2019
ms.locfileid: "75337642"
---
# <a name="poison-message-handling"></a><span data-ttu-id="c72cf-102">Gestione dei messaggi non elaborabili</span><span class="sxs-lookup"><span data-stu-id="c72cf-102">Poison Message Handling</span></span>
<span data-ttu-id="c72cf-103">Un *messaggio non elaborabile* è un messaggio che ha superato il numero massimo di tentativi di recapito all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-103">A *poison message* is a message that has exceeded the maximum number of delivery attempts to the application.</span></span> <span data-ttu-id="c72cf-104">Questa situazione può insorgere quando un'applicazione basata sulla coda non è in grado di elaborare un messaggio a causa di errori.</span><span class="sxs-lookup"><span data-stu-id="c72cf-104">This situation can arise when a queue-based application cannot process a message because of errors.</span></span> <span data-ttu-id="c72cf-105">Per far fronte a richieste di affidabilità, un'applicazione in coda riceve messaggi nell'ambito di una transazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-105">To meet reliability demands, a queued application receives messages under a transaction.</span></span> <span data-ttu-id="c72cf-106">Se la transazione nella quale è stato ricevuto un messaggio in coda viene interrotta, il messaggio resta nella coda, quindi viene eseguito un nuovo tentativo nell'ambito di una nuova transazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-106">Aborting the transaction in which a queued message was received leaves the message in the queue so that the message is retried under a new transaction.</span></span> <span data-ttu-id="c72cf-107">Se il problema che ha determinato l'interruzione della transazione non viene risolto, l'applicazione ricevente può rimanere bloccata in una successione continua di ricezioni e interruzioni dello stesso messaggio fino al raggiungimento del numero massimo di tentativi di recapito. Ne consegue l'impossibilità di elaborare il messaggio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-107">If the problem that caused the transaction to abort is not corrected, the receiving application can get stuck in a loop receiving and aborting the same message until the maximum number of delivery attempts has been exceeded and a poison message results.</span></span>  
  
 <span data-ttu-id="c72cf-108">Un messaggio può diventare non elaborabile per varie ragioni.</span><span class="sxs-lookup"><span data-stu-id="c72cf-108">A message can become a poison message for many reasons.</span></span> <span data-ttu-id="c72cf-109">Le cause più comuni sono specifiche dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-109">The most common reasons are application specific.</span></span> <span data-ttu-id="c72cf-110">Ad esempio, se un'applicazione legge un messaggio da una coda ed esegue alcune operazioni di elaborazione del database, è possibile che non riesca a ottenere un blocco per il database, causando l'interruzione della transazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-110">For example, if an application reads a message from a queue and performs some database processing, the application may fail to get a lock on the database, causing it to abort the transaction.</span></span> <span data-ttu-id="c72cf-111">A causa dell'interruzione della transazione del database, il messaggio rimane nella coda e l'applicazione è costretta a rileggerlo una seconda volta e ad eseguire un altro tentativo di acquisire un blocco sul database.</span><span class="sxs-lookup"><span data-stu-id="c72cf-111">Because the database transaction was aborted, the message remains in the queue, which causes the application to reread the message a second time and make another attempt to acquire a lock on the database.</span></span> <span data-ttu-id="c72cf-112">I messaggi, inoltre, possono diventare non elaborabili se contengono informazioni non valide.</span><span class="sxs-lookup"><span data-stu-id="c72cf-112">Messages can also become poison if they contain invalid information.</span></span> <span data-ttu-id="c72cf-113">Un ordine di acquisto, ad esempio, potrebbe contenere un numero cliente non valido.</span><span class="sxs-lookup"><span data-stu-id="c72cf-113">For example, a purchase order may contain an invalid customer number.</span></span> <span data-ttu-id="c72cf-114">In questi casi è possibile che l'applicazione interrompa a ragione la transazione determinando la trasformazione del messaggio in messaggio non elaborabile.</span><span class="sxs-lookup"><span data-stu-id="c72cf-114">In these cases, the application may voluntarily abort the transaction and force the message to become a poison message.</span></span>  
  
 <span data-ttu-id="c72cf-115">In rari casi è possibile che i messaggi non vengano inviati all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-115">On rare occasions, messages can fail to get dispatched to the application.</span></span> <span data-ttu-id="c72cf-116">Il livello Windows Communication Foundation (WCF) potrebbe rilevare un problema con il messaggio, ad esempio se il frame del messaggio non è corretto, le credenziali del messaggio non sono collegate o un'intestazione azione non valida.</span><span class="sxs-lookup"><span data-stu-id="c72cf-116">The Windows Communication Foundation (WCF) layer may find a problem with the message, such as if the message has the wrong frame, invalid message credentials attached to it, or an invalid action header.</span></span> <span data-ttu-id="c72cf-117">In questi casi l'applicazione non riceve mai il messaggio ma quest'ultimo, pur diventando non elaborabile, può essere elaborato manualmente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-117">In these cases, the application never receives the message; however, the message can still become a poison message and be processed manually.</span></span>  
  
## <a name="handling-poison-messages"></a><span data-ttu-id="c72cf-118">Gestione di messaggi non elaborabili</span><span class="sxs-lookup"><span data-stu-id="c72cf-118">Handling Poison Messages</span></span>  
 <span data-ttu-id="c72cf-119">In WCF la gestione dei messaggi non elaborabili fornisce un meccanismo in base al quale un'applicazione ricevente gestisce i messaggi che non possono essere inviati all'applicazione o i messaggi inviati all'applicazione, ma che non vengono elaborati a causa di un errore specifico dell'applicazione motivi.</span><span class="sxs-lookup"><span data-stu-id="c72cf-119">In WCF, poison message handling provides a mechanism for a receiving application to deal with messages that cannot be dispatched to the application, or messages that are dispatched to the application but which fail to be processed because of application-specific reasons.</span></span> <span data-ttu-id="c72cf-120">La gestione dei messaggi non elaborabili è configurata in base alle proprietà seguenti in ogni associazione in coda disponibile:</span><span class="sxs-lookup"><span data-stu-id="c72cf-120">Poison message handling is configured by the following properties in each of the available queued bindings:</span></span>  
  
- <span data-ttu-id="c72cf-121">`ReceiveRetryCount`.</span><span class="sxs-lookup"><span data-stu-id="c72cf-121">`ReceiveRetryCount`.</span></span> <span data-ttu-id="c72cf-122">Valore integer che indica il numero massimo di tentativi di recapito di un messaggio dalla coda dell'applicazione all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-122">An integer value that indicates the maximum number of times to retry delivery of a message from the application queue to the application.</span></span> <span data-ttu-id="c72cf-123">Il valore predefinito è 5.</span><span class="sxs-lookup"><span data-stu-id="c72cf-123">The default value is 5.</span></span> <span data-ttu-id="c72cf-124">È sufficiente nei casi in cui un tentativo immediato corregge il problema, ad esempio con un deadlock temporaneo su un database.</span><span class="sxs-lookup"><span data-stu-id="c72cf-124">This is sufficient in cases where an immediate retry fixes the problem, such as with a temporary deadlock on a database.</span></span>  
  
- <span data-ttu-id="c72cf-125">`MaxRetryCycles`.</span><span class="sxs-lookup"><span data-stu-id="c72cf-125">`MaxRetryCycles`.</span></span> <span data-ttu-id="c72cf-126">Valore integer che indica il numero massimo di cicli di ripetizione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-126">An integer value that indicates the maximum number of retry cycles.</span></span> <span data-ttu-id="c72cf-127">Un ciclo di ripetizione consiste nel trasferimento di un messaggio dalla coda dell'applicazione alla coda secondaria dei tentativi e, dopo un intervallo di tempo configurabile, dalla coda secondaria dei tentativi alla coda dell'applicazione per tentare di nuovo il recapito.</span><span class="sxs-lookup"><span data-stu-id="c72cf-127">A retry cycle consists of transferring a message from the application queue to the retry subqueue and, after a configurable delay, from the retry subqueue back into the application queue to reattempt delivery.</span></span> <span data-ttu-id="c72cf-128">Il valore predefinito è 2.</span><span class="sxs-lookup"><span data-stu-id="c72cf-128">The default value is 2.</span></span> <span data-ttu-id="c72cf-129">In Windows Vista, il messaggio viene tentato al massimo (`ReceiveRetryCount` + 1) \* (`MaxRetryCycles` + 1) volte.</span><span class="sxs-lookup"><span data-stu-id="c72cf-129">On Windows Vista, the message is tried a maximum of (`ReceiveRetryCount` +1) \* (`MaxRetryCycles` + 1) times.</span></span> <span data-ttu-id="c72cf-130">`MaxRetryCycles` viene ignorato in Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c72cf-130">`MaxRetryCycles` is ignored on Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
- <span data-ttu-id="c72cf-131">`RetryCycleDelay`.</span><span class="sxs-lookup"><span data-stu-id="c72cf-131">`RetryCycleDelay`.</span></span> <span data-ttu-id="c72cf-132">Intervallo di tempo tra cicli di ripetizione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-132">The time delay between retry cycles.</span></span> <span data-ttu-id="c72cf-133">Il valore predefinito è 30 minuti.</span><span class="sxs-lookup"><span data-stu-id="c72cf-133">The default value is 30 minutes.</span></span> <span data-ttu-id="c72cf-134">`MaxRetryCycles` e `RetryCycleDelay` forniscono insieme un meccanismo per risolvere il problema con un nuovo tentativo eseguito dopo un certo tempo.</span><span class="sxs-lookup"><span data-stu-id="c72cf-134">`MaxRetryCycles` and `RetryCycleDelay` together provide a mechanism to address the problem where a retry after a periodic delay fixes the problem.</span></span> <span data-ttu-id="c72cf-135">È ad esempio in grado di gestire un set di righe bloccate in un commit di transazioni in sospeso di SQL Server.</span><span class="sxs-lookup"><span data-stu-id="c72cf-135">For example, this handles a locked row set in SQL Server pending transaction commit.</span></span>  
  
- <span data-ttu-id="c72cf-136">`ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="c72cf-136">`ReceiveErrorHandling`.</span></span> <span data-ttu-id="c72cf-137">Enumerazione che indica l'azione da intraprendere per un messaggio non recapitato dopo il numero massimo di tentativi.</span><span class="sxs-lookup"><span data-stu-id="c72cf-137">An enumeration that indicates the action to take for a message that has failed delivery after the maximum number of retries has been attempted.</span></span> <span data-ttu-id="c72cf-138">I valori possono essere Errore, Rilascia, Rifiuta e Sposta.</span><span class="sxs-lookup"><span data-stu-id="c72cf-138">The values can be Fault, Drop, Reject, and Move.</span></span> <span data-ttu-id="c72cf-139">L'opzione predefinita è Errore.</span><span class="sxs-lookup"><span data-stu-id="c72cf-139">The default option is Fault.</span></span>  
  
- <span data-ttu-id="c72cf-140">Errore.</span><span class="sxs-lookup"><span data-stu-id="c72cf-140">Fault.</span></span> <span data-ttu-id="c72cf-141">Viene inviato un errore al listener che ha determinato l'errore di `ServiceHost`.</span><span class="sxs-lookup"><span data-stu-id="c72cf-141">This option sends a fault to the listener that caused the `ServiceHost` to fault.</span></span> <span data-ttu-id="c72cf-142">È necessario che il messaggio venga rimosso dalla coda dell'applicazione da un meccanismo esterno perché l'applicazione possa continuare a elaborare i messaggi in coda.</span><span class="sxs-lookup"><span data-stu-id="c72cf-142">The message must be removed from the application queue by some external mechanism before the application can continue to process messages from the queue.</span></span>  
  
- <span data-ttu-id="c72cf-143">Elimina.</span><span class="sxs-lookup"><span data-stu-id="c72cf-143">Drop.</span></span> <span data-ttu-id="c72cf-144">Il messaggio non elaborabile viene eliminato e non verrà mai recapitato all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-144">This option drops the poison message and the message is never delivered to the application.</span></span> <span data-ttu-id="c72cf-145">Se a questo punto la proprietà `TimeToLive` del messaggio è scaduta, è possibile che il messaggio venga visualizzato nella coda dei messaggi non recapitabili del mittente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-145">If the message's `TimeToLive` property has expired at this point, then the message may appear in the sender's dead-letter queue.</span></span> <span data-ttu-id="c72cf-146">In caso contrario, il messaggio non viene visualizzato mai.</span><span class="sxs-lookup"><span data-stu-id="c72cf-146">If not, the message does not appear anywhere.</span></span> <span data-ttu-id="c72cf-147">L'opzione indica che l'utente non ha specificato l'operazione da eseguire in caso di perdita del messaggio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-147">This option indicates that the user has not specified what to do if the message is lost.</span></span>  
  
- <span data-ttu-id="c72cf-148">Rifiuta.</span><span class="sxs-lookup"><span data-stu-id="c72cf-148">Reject.</span></span> <span data-ttu-id="c72cf-149">Questa opzione è disponibile solo in Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c72cf-149">This option is available only on Windows Vista.</span></span> <span data-ttu-id="c72cf-150">Viene indicato a MSMQ di inviare al gestore code mittente un acknowledgement negativo che indichi che l'applicazione non è in grado di ricevere il messaggio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-150">This instructs Message Queuing (MSMQ) to send a negative acknowledgement back to the sending queue manager that the application cannot receive the message.</span></span> <span data-ttu-id="c72cf-151">Il messaggio viene inserito nella coda di messaggi non recapitabili del gestore code mittente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-151">The message is placed in the sending queue manager's dead-letter queue.</span></span>  
  
- <span data-ttu-id="c72cf-152">Sposta.</span><span class="sxs-lookup"><span data-stu-id="c72cf-152">Move.</span></span> <span data-ttu-id="c72cf-153">Questa opzione è disponibile solo in Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c72cf-153">This option is available only on Windows Vista.</span></span> <span data-ttu-id="c72cf-154">Il messaggio non elaborabile viene spostato in una coda di messaggi non elaborabili per l'elaborazione successiva da parte di un'applicazione di gestione apposita.</span><span class="sxs-lookup"><span data-stu-id="c72cf-154">This moves the poison message to a poison-message queue for later processing by a poison-message handling application.</span></span> <span data-ttu-id="c72cf-155">La coda di messaggi non elaborabili è una coda secondaria della coda dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-155">The poison-message queue is a subqueue of the application queue.</span></span> <span data-ttu-id="c72cf-156">Un'applicazione per la gestione di messaggi non elaborabili può essere un servizio WCF che legge i messaggi dalla coda non elaborabile.</span><span class="sxs-lookup"><span data-stu-id="c72cf-156">A poison-message handling application can be a WCF service that reads messages out of the poison queue.</span></span> <span data-ttu-id="c72cf-157">La coda non elaborabile è una coda secondaria della coda dell'applicazione e può essere risolta come NET. MSMQ://\<*nome computer*>/*applicationQueue*;p Baptiste Oison, dove *nome-* computer è il nome del computer in cui risiede la coda e *applicationQueue* è il nome della coda specifica dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-157">The poison queue is a subqueue of the application queue and can be addressed as net.msmq://\<*machine-name*>/*applicationQueue*;poison, where *machine-name* is the name of the computer on which the queue resides and the *applicationQueue* is the name of the application-specific queue.</span></span>  
  
 <span data-ttu-id="c72cf-158">Di seguito è indicato il numero massimo di tentativi di recapito possibili per un messaggio:</span><span class="sxs-lookup"><span data-stu-id="c72cf-158">The following are the maximum number of delivery attempts made for a message:</span></span>  
  
- <span data-ttu-id="c72cf-159">((ReceiveRetryCount + 1) \* (MaxRetryCycles + 1)) in Windows Vista.</span><span class="sxs-lookup"><span data-stu-id="c72cf-159">((ReceiveRetryCount+1) \* (MaxRetryCycles + 1)) on Windows Vista.</span></span>  
  
- <span data-ttu-id="c72cf-160">(ReceiveRetryCount + 1) in Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c72cf-160">(ReceiveRetryCount + 1) on Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c72cf-161">Non vengono eseguiti altri tentativi per i messaggi recapitati correttamente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-161">No retries are made for a message that is delivered successfully.</span></span>  
  
 <span data-ttu-id="c72cf-162">Per tenere traccia del numero di tentativi di lettura di un messaggio, Windows Vista mantiene una proprietà durevole del messaggio che conta il numero di interruzioni e una proprietà del conteggio di spostamento che conta il numero di volte in cui il messaggio si sposta tra la coda dell'applicazione e le code secondarie.</span><span class="sxs-lookup"><span data-stu-id="c72cf-162">To keep track of the number of times a message read is attempted, Windows Vista maintains a durable message property that counts the number of aborts and a move count property that counts the number of times the message moves between the application queue and subqueues.</span></span> <span data-ttu-id="c72cf-163">Il canale WCF utilizza questi per calcolare il numero di tentativi di ricezione e il numero di cicli di ripetizione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-163">The WCF channel uses these to compute the receive retry count and the retry cycles count.</span></span> <span data-ttu-id="c72cf-164">In Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)]il numero di interruzioni viene mantenuto in memoria dal canale WCF e viene reimpostato in caso di errore dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-164">On Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)], the abort count is maintained in memory by the WCF channel and is reset if the application fails.</span></span> <span data-ttu-id="c72cf-165">Inoltre, il canale WCF può conservare i conteggi delle interruzioni per un massimo di 256 messaggi in memoria in qualsiasi momento.</span><span class="sxs-lookup"><span data-stu-id="c72cf-165">Also, the WCF channel can hold the abort counts for up to 256 messages in memory at any time.</span></span> <span data-ttu-id="c72cf-166">Se viene letto il 257° messaggio, il messaggio più vecchio viene eliminato dal conteggio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-166">If a 257th message is read, then the oldest message's abort count is reset.</span></span>  
  
 <span data-ttu-id="c72cf-167">Le proprietà del numero di interruzioni e del numero di spostamenti sono a disposizione dell'operazione del servizio mediante il contesto dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-167">The abort count and move count properties are available to the service operation through the operation context.</span></span> <span data-ttu-id="c72cf-168">Nell'esempio di codice seguente viene spiegato come accedervi.</span><span class="sxs-lookup"><span data-stu-id="c72cf-168">The following code example shows how to access them.</span></span>  
  
 [!code-csharp[S_UE_MSMQ_Poison#1](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/service.cs#1)]  
  
 <span data-ttu-id="c72cf-169">WCF fornisce due associazioni in coda standard:</span><span class="sxs-lookup"><span data-stu-id="c72cf-169">WCF provides two standard queued bindings:</span></span>  
  
- <span data-ttu-id="c72cf-170"><xref:System.ServiceModel.NetMsmqBinding>.</span><span class="sxs-lookup"><span data-stu-id="c72cf-170"><xref:System.ServiceModel.NetMsmqBinding>.</span></span> <span data-ttu-id="c72cf-171">Associazione .NET Framework adatta per l'esecuzione di comunicazioni basate su coda con altri endpoint WCF.</span><span class="sxs-lookup"><span data-stu-id="c72cf-171">A .NET Framework binding suitable for performing queue-based communication with other WCF endpoints.</span></span>  
  
- <span data-ttu-id="c72cf-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span><span class="sxs-lookup"><span data-stu-id="c72cf-172"><xref:System.ServiceModel.MsmqIntegration.MsmqIntegrationBinding>.</span></span> <span data-ttu-id="c72cf-173">Associazione idonea per la comunicazione con applicazioni di accodamento messaggi esistenti.</span><span class="sxs-lookup"><span data-stu-id="c72cf-173">A binding suitable for communicating with existing Message Queuing applications.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="c72cf-174">È possibile modificare le proprietà in questi binding in base ai requisiti del servizio WCF.</span><span class="sxs-lookup"><span data-stu-id="c72cf-174">You can alter properties in these bindings based on the requirements of your WCF service.</span></span> <span data-ttu-id="c72cf-175">L'intero meccanismo di gestione dei messaggi non elaborabili è locale nell'applicazione ricevente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-175">The entire poison message handling mechanism is local to the receiving application.</span></span> <span data-ttu-id="c72cf-176">A meno che l'applicazione ricevente non venga arrestata e non venga inviato un acknowledgment negativo al mittente, il processo è invisibile all'applicazione mittente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-176">The process is invisible to the sending application unless the receiving application ultimately stops and sends a negative acknowledgment back to the sender.</span></span> <span data-ttu-id="c72cf-177">In questo caso il messaggio viene spostato nella coda dei messaggi non recapitabili del mittente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-177">In that case, the message is moved to the sender's dead-letter queue.</span></span>  
  
## <a name="best-practice-handling-msmqpoisonmessageexception"></a><span data-ttu-id="c72cf-178">Procedura consigliata: gestione di MsmqPoisonMessageException</span><span class="sxs-lookup"><span data-stu-id="c72cf-178">Best Practice: Handling MsmqPoisonMessageException</span></span>  
 <span data-ttu-id="c72cf-179">Quando il servizio stabilisce che un messaggio non è elaborabile, il trasporto in coda genera un'eccezione <xref:System.ServiceModel.MsmqPoisonMessageException> contenente il `LookupId` del messaggio non elaborabile.</span><span class="sxs-lookup"><span data-stu-id="c72cf-179">When the service determines that a message is poison, the queued transport throws a <xref:System.ServiceModel.MsmqPoisonMessageException> that contains the `LookupId` of the poison message.</span></span>  
  
 <span data-ttu-id="c72cf-180">Un'applicazione ricevente può implementare l'interfaccia <xref:System.ServiceModel.Dispatcher.IErrorHandler> per gestire qualsiasi errore che l'applicazione richieda.</span><span class="sxs-lookup"><span data-stu-id="c72cf-180">A receiving application can implement the <xref:System.ServiceModel.Dispatcher.IErrorHandler> interface to handle any errors that the application requires.</span></span> <span data-ttu-id="c72cf-181">Per ulteriori informazioni, vedere [estensione del controllo sulla gestione degli errori e creazione di report](../../../../docs/framework/wcf/samples/extending-control-over-error-handling-and-reporting.md).</span><span class="sxs-lookup"><span data-stu-id="c72cf-181">For more information, see [Extending Control Over Error Handling and Reporting](../../../../docs/framework/wcf/samples/extending-control-over-error-handling-and-reporting.md).</span></span>  
  
 <span data-ttu-id="c72cf-182">L'applicazione potrebbe richiedere una forma di gestione automatica dei messaggi non elaborabili per spostare tali messaggi in una coda apposita affinché il servizio possa accedere al resto dei messaggi presenti nella coda.</span><span class="sxs-lookup"><span data-stu-id="c72cf-182">The application may require some kind of automated handling of poison messages that moves the poison messages to a poison message queue so that the service can access the rest of the messages in the queue.</span></span> <span data-ttu-id="c72cf-183">L'unico scenario in cui viene utilizzato il meccanismo di gestione degli errori per rimanere in attesa delle eccezioni di messaggi non elaborabili si verifica quanto la proprietà <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> è impostata su <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span><span class="sxs-lookup"><span data-stu-id="c72cf-183">The only scenario for using the error-handler mechanism to listen for poison-message exceptions is when the <xref:System.ServiceModel.Configuration.MsmqBindingElementBase.ReceiveErrorHandling%2A> setting is set to <xref:System.ServiceModel.ReceiveErrorHandling.Fault>.</span></span> <span data-ttu-id="c72cf-184">Nell'esempio di messaggio non elaborabile per Accodamento messaggi 3.0 viene illustrato questo comportamento.</span><span class="sxs-lookup"><span data-stu-id="c72cf-184">The poison-message sample for Message Queuing 3.0 demonstrates this behavior.</span></span> <span data-ttu-id="c72cf-185">Di seguito vengono descritti i passaggi necessari per gestire i messaggi non elaborabili, comprese le procedure consigliate:</span><span class="sxs-lookup"><span data-stu-id="c72cf-185">The following outlines the steps to take to handle poison messages, including best practices:</span></span>  
  
1. <span data-ttu-id="c72cf-186">Assicurarsi che le impostazioni dei messaggi non elaborabili rispettino i requisiti dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-186">Ensure your poison settings reflect the requirements of your application.</span></span> <span data-ttu-id="c72cf-187">Quando si utilizzano le impostazioni, assicurarsi di comprendere le differenze tra le funzionalità di Accodamento messaggi in Windows Vista, Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c72cf-187">When working with the settings, ensure that you understand the differences between the capabilities of Message Queuing on Windows Vista, Windows Server 2003, and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
2. <span data-ttu-id="c72cf-188">Se necessario, implementare `IErrorHandler` per gestire gli errori di messaggi non elaborabili.</span><span class="sxs-lookup"><span data-stu-id="c72cf-188">If required, implement the `IErrorHandler` to handle poison-message errors.</span></span> <span data-ttu-id="c72cf-189">Poiché l'impostazione di `ReceiveErrorHandling` su `Fault` richiede un meccanismo manuale per rimuovere dalla coda il messaggio non elaborabile o per correggere un problema collegato esterno, l'utilizzo tipico consiste nell'implementare `IErrorHandler` quando `ReceiveErrorHandling` è impostato su `Fault`, come illustrato nel codice seguente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-189">Because setting `ReceiveErrorHandling` to `Fault` requires a manual mechanism to move the poison message out of the queue or to correct an external dependent issue, the typical usage is to implement `IErrorHandler` when `ReceiveErrorHandling` is set to `Fault`, as shown in the following code.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#2](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonerrorhandler.cs#2)]  
  
3. <span data-ttu-id="c72cf-190">Creare un attributo `PoisonBehaviorAttribute` che possa essere utilizzato dal comportamento del servizio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-190">Create a `PoisonBehaviorAttribute` that the service behavior can use.</span></span> <span data-ttu-id="c72cf-191">Il comportamento installa `IErrorHandler` nel dispatcher.</span><span class="sxs-lookup"><span data-stu-id="c72cf-191">The behavior installs the `IErrorHandler` on the dispatcher.</span></span> <span data-ttu-id="c72cf-192">Vedere l'esempio di codice seguente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-192">See the following code example.</span></span>  
  
     [!code-csharp[S_UE_MSMQ_Poison#3](../../../../samples/snippets/csharp/VS_Snippets_CFX/s_ue_msmq_poison/cs/poisonbehaviorattribute.cs#3)]  
  
4. <span data-ttu-id="c72cf-193">Assicurarsi che il servizio sia annotato con l'attributo del comportamento non elaborabile.</span><span class="sxs-lookup"><span data-stu-id="c72cf-193">Ensure that your service is annotated with the poison behavior attribute.</span></span>  

 <span data-ttu-id="c72cf-194">Inoltre, se `ReceiveErrorHandling` è impostato su `Fault`, in `ServiceHost` si verificherà un errore in presenza di un messaggio non elaborabile.</span><span class="sxs-lookup"><span data-stu-id="c72cf-194">In addition, if the `ReceiveErrorHandling` is set to `Fault`, the `ServiceHost` faults when encountering the poison message.</span></span> <span data-ttu-id="c72cf-195">È possibile associare l'evento di errore e arrestare il servizio, adottare azioni correttive e riavviare.</span><span class="sxs-lookup"><span data-stu-id="c72cf-195">You can hook up to the faulted event and shut down the service, take corrective actions, and restart.</span></span> <span data-ttu-id="c72cf-196">Ad esempio, è possibile notare `LookupId` in <xref:System.ServiceModel.MsmqPoisonMessageException> propagato in `IErrorHandler` e quando si verifica un errore nell'host del servizio, è possibile utilizzare l'API `System.Messaging` per ricevere il messaggio dalla coda tramite `LookupId`, rimuovere il messaggio dalla coda e archiviarlo in un archivio esterno o in un'altra coda.</span><span class="sxs-lookup"><span data-stu-id="c72cf-196">For example, the `LookupId` in the <xref:System.ServiceModel.MsmqPoisonMessageException> propagated to the `IErrorHandler` can be noted and when the service host faults, you could use the `System.Messaging` API to receive the message from the queue using the `LookupId` to remove the message from the queue and store the message in some external store or another queue.</span></span> <span data-ttu-id="c72cf-197">È quindi possibile riavviare il `ServiceHost` per riprendere l'elaborazione normale.</span><span class="sxs-lookup"><span data-stu-id="c72cf-197">You can then restart `ServiceHost` to resume normal processing.</span></span> <span data-ttu-id="c72cf-198">La [gestione dei messaggi non elaborabili in MSMQ 4,0](../../../../docs/framework/wcf/samples/poison-message-handling-in-msmq-4-0.md) illustra questo comportamento.</span><span class="sxs-lookup"><span data-stu-id="c72cf-198">The [Poison Message Handling in MSMQ 4.0](../../../../docs/framework/wcf/samples/poison-message-handling-in-msmq-4-0.md) demonstrates this behavior.</span></span>  
  
## <a name="transaction-time-out-and-poison-messages"></a><span data-ttu-id="c72cf-199">Timeout della transazione e messaggi non elaborabili</span><span class="sxs-lookup"><span data-stu-id="c72cf-199">Transaction Time-Out and Poison Messages</span></span>  
 <span data-ttu-id="c72cf-200">È possibile che si verifichi una classe di errori tra il canale del trasporto in coda e il codice utente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-200">A class of errors can occur between the queued transport channel and the user code.</span></span> <span data-ttu-id="c72cf-201">Gli errori possono essere rilevati da livelli intermedi, ad esempio il livello di sicurezza del messaggio o la logica di invio del servizio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-201">These errors can be detected by layers in-between, such as the message security layer or the service dispatching logic.</span></span> <span data-ttu-id="c72cf-202">Ad esempio, un certificato X.509 mancante rilevato nel livello di sicurezza SOAP e un'azione mancante sono casi in cui il messaggio viene inviato all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-202">For example, a missing X.509 certificate detected in the SOAP security layer and a missing action are cases where the message does get dispatched to the application.</span></span> <span data-ttu-id="c72cf-203">In queste situazioni, il messaggio viene eliminato dal modello del servizio.</span><span class="sxs-lookup"><span data-stu-id="c72cf-203">When this happens, the service model drops the message.</span></span> <span data-ttu-id="c72cf-204">Poiché il messaggio viene letto in una transazione per la quale non può essere fornito alcun risultato, la transazione alla fine scade, viene interrotta e il messaggio viene nuovamente inserito nella coda.</span><span class="sxs-lookup"><span data-stu-id="c72cf-204">Because the message is read in a transaction and an outcome for that transaction cannot be provided, the transaction eventually times out, aborts, and the message is put back into the queue.</span></span> <span data-ttu-id="c72cf-205">In altre parole, per una determinata classe di errori, la transazione non viene immediatamente interrotta ma resta in attesa fino al timeout della transazione. È possibile modificare il timeout della transazione per un servizio utilizzando <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span><span class="sxs-lookup"><span data-stu-id="c72cf-205">In other words, for a certain class of errors, the transaction does not immediately abort but waits until the transaction times out. You can modify the transaction time-out for a service using <xref:System.ServiceModel.ServiceBehaviorAttribute>.</span></span>  
  
 <span data-ttu-id="c72cf-206">Per modificare il timeout della transazione a livello di computer, modificare il file Machine. config e impostare il timeout della transazione appropriato. È importante notare che, a seconda del timeout impostato nella transazione, la transazione alla fine viene interrotta e torna alla coda e il relativo numero di interruzioni viene incrementato.</span><span class="sxs-lookup"><span data-stu-id="c72cf-206">To change the transaction time-out on a computer-wide basis, modify the machine.config file and set the appropriate transaction time-out. It is important to note that, depending on the time-out set in the transaction, the transaction eventually aborts and goes back to the queue and its abort count is incremented.</span></span> <span data-ttu-id="c72cf-207">Il messaggio diventerà non elaborabile e verranno eseguite le azioni di eliminazione appropriate in base alle impostazioni dell'utente.</span><span class="sxs-lookup"><span data-stu-id="c72cf-207">Eventually, the message becomes poison and the right disposition is made according to the user settings.</span></span>  
  
## <a name="sessions-and-poison-messages"></a><span data-ttu-id="c72cf-208">Sessioni e messaggi non elaborabili</span><span class="sxs-lookup"><span data-stu-id="c72cf-208">Sessions and Poison Messages</span></span>  
 <span data-ttu-id="c72cf-209">Una sessione subisce le stesse procedure di ripetizione e gestione di messaggi non elaborabili di un messaggio singolo.</span><span class="sxs-lookup"><span data-stu-id="c72cf-209">A session undergoes the same retry and poison-message handling procedures as a single message.</span></span> <span data-ttu-id="c72cf-210">Le proprietà elencate in precedenza per i messaggi non elaborabili sono applicabili all'intera sessione.</span><span class="sxs-lookup"><span data-stu-id="c72cf-210">The properties previously listed for poison messages apply to the entire session.</span></span> <span data-ttu-id="c72cf-211">Ciò significa che l'intera sessione verrà ripetuta e verrà inserita in una coda finale di messaggi non elaborabili o nella coda di messaggi non recapitabili del mittente se il messaggio verrà rifiutato.</span><span class="sxs-lookup"><span data-stu-id="c72cf-211">This means that the entire session is retried and goes to a final poison-message queue or the sender’s dead-letter queue if the message is rejected.</span></span>  
  
## <a name="batching-and-poison-messages"></a><span data-ttu-id="c72cf-212">Batch e messaggi non elaborabili</span><span class="sxs-lookup"><span data-stu-id="c72cf-212">Batching and Poison Messages</span></span>  
 <span data-ttu-id="c72cf-213">Se un messaggio diventa non elaborabile e fa parte di un batch, viene eseguito il rollback dell'intero batch e il canale riprende a leggere i messaggi uno alla volta.</span><span class="sxs-lookup"><span data-stu-id="c72cf-213">If a message becomes a poison message and is part of a batch, then the entire batch is rolled back and the channel returns to reading one message at a time.</span></span> <span data-ttu-id="c72cf-214">Per ulteriori informazioni sulla suddivisione in batch, vedere [invio in batch di messaggi in una transazione](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md)</span><span class="sxs-lookup"><span data-stu-id="c72cf-214">For more information about batching, see [Batching Messages in a Transaction](../../../../docs/framework/wcf/feature-details/batching-messages-in-a-transaction.md)</span></span>  
  
## <a name="poison-message-handling-for-messages-in-a-poison-queue"></a><span data-ttu-id="c72cf-215">Gestione di messaggi non elaborabili per messaggi di una coda non elaborabile</span><span class="sxs-lookup"><span data-stu-id="c72cf-215">Poison-message Handling for Messages in a Poison Queue</span></span>  
 <span data-ttu-id="c72cf-216">La gestione di messaggi non elaborabili non termina quando un messaggio viene inserito nella coda di messaggi non elaborabili.</span><span class="sxs-lookup"><span data-stu-id="c72cf-216">Poison-message handling does not end when a message is placed in the poison-message queue.</span></span> <span data-ttu-id="c72cf-217">I messaggi presenti nella coda di messaggi non elaborabili devono comunque essere letti e gestiti.</span><span class="sxs-lookup"><span data-stu-id="c72cf-217">Messages in the poison-message queue must still be read and handled.</span></span> <span data-ttu-id="c72cf-218">È possibile utilizzare un sottoinsieme di impostazioni della gestione di messaggi non elaborabili durante la lettura di messaggi dalla coda secondaria non elaborabile finale.</span><span class="sxs-lookup"><span data-stu-id="c72cf-218">You can use a subset of the poison-message handling settings when reading messages from the final poison subqueue.</span></span> <span data-ttu-id="c72cf-219">Le impostazioni applicabili sono `ReceiveRetryCount` e `ReceiveErrorHandling`.</span><span class="sxs-lookup"><span data-stu-id="c72cf-219">The applicable settings are `ReceiveRetryCount` and `ReceiveErrorHandling`.</span></span> <span data-ttu-id="c72cf-220">È possibile impostare `ReceiveErrorHandling` su Drop, Reject o Fault.</span><span class="sxs-lookup"><span data-stu-id="c72cf-220">You can set `ReceiveErrorHandling` to Drop, Reject, or Fault.</span></span> <span data-ttu-id="c72cf-221">`MaxRetryCycles` viene ignorato e viene generata un'eccezione se `ReceiveErrorHandling` è impostato su Move.</span><span class="sxs-lookup"><span data-stu-id="c72cf-221">`MaxRetryCycles` is ignored and an exception is thrown if `ReceiveErrorHandling` is set to Move.</span></span>  
  
## <a name="windows-vista-windows-server-2003-and-windows-xp-differences"></a><span data-ttu-id="c72cf-222">Differenze tra Windows Vista, Windows Server 2003 e Windows XP</span><span class="sxs-lookup"><span data-stu-id="c72cf-222">Windows Vista, Windows Server 2003, and Windows XP Differences</span></span>  
 <span data-ttu-id="c72cf-223">Come indicato in precedenza, non tutte le impostazioni di gestione dei messaggi non elaborabili si applicano a Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c72cf-223">As noted earlier, not all poison-message handling settings apply to Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span> <span data-ttu-id="c72cf-224">Le seguenti differenze principali tra Accodamento messaggi in Windows Server 2003, [!INCLUDE[wxp](../../../../includes/wxp-md.md)]e Windows Vista sono rilevanti per la gestione dei messaggi non elaborabili:</span><span class="sxs-lookup"><span data-stu-id="c72cf-224">The following key differences between Message Queuing on Windows Server 2003, [!INCLUDE[wxp](../../../../includes/wxp-md.md)], and Windows Vista are relevant to poison-message handling:</span></span>  
  
- <span data-ttu-id="c72cf-225">Accodamento messaggi in Windows Vista supporta le code secondarie, mentre Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)] non supportano le code secondarie.</span><span class="sxs-lookup"><span data-stu-id="c72cf-225">Message Queuing in Windows Vista supports subqueues, while Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)] do not support subqueues.</span></span> <span data-ttu-id="c72cf-226">Le code secondarie vengono utilizzate nella gestione dei messaggi non elaborabili.</span><span class="sxs-lookup"><span data-stu-id="c72cf-226">Subqueues are used in poison-message handling.</span></span> <span data-ttu-id="c72cf-227">Le code di tentativi e la coda non elaborabile sono code secondarie della coda dell'applicazione creata in base alle impostazioni di gestione dei messaggi non elaborabili.</span><span class="sxs-lookup"><span data-stu-id="c72cf-227">The retry queues and the poison queue are subqueues to the application queue that is created based on the poison-message handling settings.</span></span> <span data-ttu-id="c72cf-228">`MaxRetryCycles` stabilisce il numero delle code secondarie dei tentativi che verranno create.</span><span class="sxs-lookup"><span data-stu-id="c72cf-228">The `MaxRetryCycles` dictates how many retry subqueues to create.</span></span> <span data-ttu-id="c72cf-229">Pertanto, in caso di esecuzione in Windows Server 2003 o [!INCLUDE[wxp](../../../../includes/wxp-md.md)], `MaxRetryCycles` vengono ignorate e `ReceiveErrorHandling.Move` non è consentito.</span><span class="sxs-lookup"><span data-stu-id="c72cf-229">Therefore, when running on Windows Server 2003 or [!INCLUDE[wxp](../../../../includes/wxp-md.md)], `MaxRetryCycles` are ignored and `ReceiveErrorHandling.Move` is not allowed.</span></span>  
  
- <span data-ttu-id="c72cf-230">Accodamento messaggi in Windows Vista supporta il riconoscimento negativo, mentre Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)] non lo sono.</span><span class="sxs-lookup"><span data-stu-id="c72cf-230">Message Queuing in Windows Vista supports negative acknowledgment, while Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)] do not.</span></span> <span data-ttu-id="c72cf-231">Un negative acknowledgment dal gestore delle code ricevente determina l'inserimento, da parte del gestore delle code mittente, del messaggio respinto nella coda dei messaggi non recapitabili.</span><span class="sxs-lookup"><span data-stu-id="c72cf-231">A negative acknowledgment from the receiving queue manager causes the sending queue manager to place the rejected message in the dead-letter queue.</span></span> <span data-ttu-id="c72cf-232">Di conseguenza, `ReceiveErrorHandling.Reject` non è consentito con Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c72cf-232">As such, `ReceiveErrorHandling.Reject` is not allowed with Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span>  
  
- <span data-ttu-id="c72cf-233">Accodamento messaggi in Windows Vista supporta una proprietà del messaggio che mantiene il conteggio del numero di tentativi di recapito dei messaggi.</span><span class="sxs-lookup"><span data-stu-id="c72cf-233">Message Queuing in Windows Vista supports a message property that keeps count of the number of times message delivery is attempted.</span></span> <span data-ttu-id="c72cf-234">Questa proprietà del numero di interruzioni non è disponibile in Windows Server 2003 e [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span><span class="sxs-lookup"><span data-stu-id="c72cf-234">This abort count property is not available on Windows Server 2003 and [!INCLUDE[wxp](../../../../includes/wxp-md.md)].</span></span> <span data-ttu-id="c72cf-235">WCF mantiene il conteggio delle interruzioni in memoria, pertanto è possibile che questa proprietà non contenga un valore accurato quando lo stesso messaggio viene letto da più di un servizio WCF in una farm.</span><span class="sxs-lookup"><span data-stu-id="c72cf-235">WCF maintains the abort count in memory, so it is possible that this property may not contain an accurate value when the same message is read by more than one WCF service in a farm.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="c72cf-236">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="c72cf-236">See also</span></span>

- [<span data-ttu-id="c72cf-237">Panoramica delle code</span><span class="sxs-lookup"><span data-stu-id="c72cf-237">Queues Overview</span></span>](../../../../docs/framework/wcf/feature-details/queues-overview.md)
- [<span data-ttu-id="c72cf-238">Differenze nelle funzionalità di accodamento in Windows Vista, Windows Server 2003 e Windows XP</span><span class="sxs-lookup"><span data-stu-id="c72cf-238">Differences in Queuing Features in Windows Vista, Windows Server 2003, and Windows XP</span></span>](../../../../docs/framework/wcf/feature-details/diff-in-queue-in-vista-server-2003-windows-xp.md)
- [<span data-ttu-id="c72cf-239">Specifica e gestione degli errori in contratti e servizi</span><span class="sxs-lookup"><span data-stu-id="c72cf-239">Specifying and Handling Faults in Contracts and Services</span></span>](../../../../docs/framework/wcf/specifying-and-handling-faults-in-contracts-and-services.md)
