---
title: Valori restituiti e variabili locali ref (Guida a C#)
description: Informazioni su come definire e usare valori restituiti e variabili locali ref
ms.date: 04/04/2018
ms.openlocfilehash: 87a9538db60d69062f0fb48ed9683a9d4f972b91
ms.sourcegitcommit: 7588136e355e10cbc2582f389c90c127363c02a5
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 03/14/2020
ms.locfileid: "79170073"
---
# <a name="ref-returns-and-ref-locals"></a><span data-ttu-id="bffc3-103">Valori restituiti e variabili locali ref</span><span class="sxs-lookup"><span data-stu-id="bffc3-103">Ref returns and ref locals</span></span>

<span data-ttu-id="bffc3-104">A partire da C# 7.0, C# supporta i valori restituiti di riferimento (valori restituiti ref).</span><span class="sxs-lookup"><span data-stu-id="bffc3-104">Starting with C# 7.0, C# supports reference return values (ref returns).</span></span> <span data-ttu-id="bffc3-105">Un valore restituito di riferimento consente a un metodo di restituire a un chiamante un riferimento a una variabile, invece di un valore.</span><span class="sxs-lookup"><span data-stu-id="bffc3-105">A reference return value allows a method to return a reference to a variable, rather than a value, back to a caller.</span></span> <span data-ttu-id="bffc3-106">Il chiamante può quindi scegliere di trattare la variabile come se fosse stata restituita da un valore o un riferimento.</span><span class="sxs-lookup"><span data-stu-id="bffc3-106">The caller can then choose to treat the returned variable as if it were returned by value or by reference.</span></span> <span data-ttu-id="bffc3-107">Il chiamante può creare una nuova variabile che è di per sé un riferimento al valore restituito, chiamata variabile locale ref.</span><span class="sxs-lookup"><span data-stu-id="bffc3-107">The caller can create a new variable that is itself a reference to the returned value, called a ref local.</span></span>

## <a name="what-is-a-reference-return-value"></a><span data-ttu-id="bffc3-108">Che cos'è un valore restituito di riferimento?</span><span class="sxs-lookup"><span data-stu-id="bffc3-108">What is a reference return value?</span></span>

<span data-ttu-id="bffc3-109">La maggior parte degli sviluppatori ha familiarità con il passaggio di un argomento a un metodo chiamato *tramite un riferimento*.</span><span class="sxs-lookup"><span data-stu-id="bffc3-109">Most developers are familiar with passing an argument to a called method *by reference*.</span></span> <span data-ttu-id="bffc3-110">L'elenco di argomenti di un metodo chiamato include una variabile passata per riferimento.</span><span class="sxs-lookup"><span data-stu-id="bffc3-110">A called method's argument list includes a variable passed by reference.</span></span> <span data-ttu-id="bffc3-111">Qualsiasi modifica apportata al relativo valore dal metodo chiamato viene rispettata dal chiamante.</span><span class="sxs-lookup"><span data-stu-id="bffc3-111">Any changes made to its value by the called method are observed by the caller.</span></span> <span data-ttu-id="bffc3-112">Un *valore restituito di riferimento* indica che un metodo restituisce un *riferimento* (o alias) a una variabile.</span><span class="sxs-lookup"><span data-stu-id="bffc3-112">A *reference return value* means that a method returns a *reference* (or an alias) to some variable.</span></span> <span data-ttu-id="bffc3-113">L'ambito di tale variabile deve includere il metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-113">That variable's scope must include the method.</span></span> <span data-ttu-id="bffc3-114">La durata della variabile deve estendersi oltre la restituzione del controllo del metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-114">That variable's lifetime must extend beyond the return of the method.</span></span> <span data-ttu-id="bffc3-115">Le modifiche effettuate dal chiamante al valore restituito del metodo vengono apportate alla variabile restituita dal metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-115">Modifications to the method's return value by the caller are made to the variable that is returned by the method.</span></span>

<span data-ttu-id="bffc3-116">La dichiarazione che un metodo restituisce un *valore restituito di riferimento* indica che il metodo restituisce un alias a una variabile.</span><span class="sxs-lookup"><span data-stu-id="bffc3-116">Declaring that a method returns a *reference return value* indicates that the method returns an alias to a variable.</span></span> <span data-ttu-id="bffc3-117">La finalità della progettazione è spesso quella di fare in modo che il codice chiamante abbia accesso a tale variabile tramite l'alias, inclusa la possibilità di modificarla.</span><span class="sxs-lookup"><span data-stu-id="bffc3-117">The design intent is often that the calling code should have access to that variable through the alias, including to modify it.</span></span> <span data-ttu-id="bffc3-118">Ne consegue che i metodi restituiti per riferimento non possono avere il tipo restituito `void`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-118">It follows that methods returning by reference can't have the return type `void`.</span></span>

<span data-ttu-id="bffc3-119">Esistono alcune restrizioni per l'espressione che un metodo può restituire come valore restituito di riferimento.</span><span class="sxs-lookup"><span data-stu-id="bffc3-119">There are some restrictions on the expression that a method can return as a reference return value.</span></span> <span data-ttu-id="bffc3-120">Tali restrizioni includono:</span><span class="sxs-lookup"><span data-stu-id="bffc3-120">Restrictions include:</span></span>

- <span data-ttu-id="bffc3-121">Il valore restituito deve avere una durata che si estende oltre l'esecuzione del metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-121">The return value must have a lifetime that extends beyond the execution of the method.</span></span> <span data-ttu-id="bffc3-122">In altre parole, non può essere una variabile locale nel metodo che la restituisce.</span><span class="sxs-lookup"><span data-stu-id="bffc3-122">In other words, it cannot be a local variable in the method that returns it.</span></span> <span data-ttu-id="bffc3-123">Può essere un'istanza o un campo statico di una classe oppure un argomento passato al metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-123">It can be an instance or static field of a class, or it can be an argument passed to the method.</span></span> <span data-ttu-id="bffc3-124">Se si tenta di restituire una variabile locale, viene generato l'errore del compilatore CS8168, "Non è possibile restituire la variabile locale 'obj' per riferimento perché non è una variabile locale ref".</span><span class="sxs-lookup"><span data-stu-id="bffc3-124">Attempting to return a local variable generates compiler error CS8168, "Cannot return local 'obj' by reference because it is not a ref local."</span></span>

- <span data-ttu-id="bffc3-125">Il valore restituito non può essere il valore letterale `null`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-125">The return value cannot be the literal `null`.</span></span> <span data-ttu-id="bffc3-126">La restituzione di `null` genera l'errore del compilatore CS8156, "Non è possibile usare un'espressione in questo contesto perché non può essere restituita per riferimento".</span><span class="sxs-lookup"><span data-stu-id="bffc3-126">Returning `null` generates compiler error CS8156, "An expression cannot be used in this context because it may not be returned by reference."</span></span>

   <span data-ttu-id="bffc3-127">Un metodo con un ref restituito può restituire un alias a una variabile il cui valore è attualmente il valore null (senza istanze) o un tipo di [valore nullable](../../language-reference/builtin-types/nullable-value-types.md) per un tipo di valore.</span><span class="sxs-lookup"><span data-stu-id="bffc3-127">A method with a ref return can return an alias to a variable whose value is currently the null (uninstantiated) value or a [nullable value type](../../language-reference/builtin-types/nullable-value-types.md) for a value type.</span></span>

- <span data-ttu-id="bffc3-128">Il valore restituito non può essere una costante, un membro di enumerazione, il valore restituito per valore da una proprietà o un metodo di un oggetto `class` o `struct`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-128">The return value cannot be a constant, an enumeration member, the by-value return value from a property, or a method of a `class` or `struct`.</span></span> <span data-ttu-id="bffc3-129">La violazione di questa regola genera l'errore del compilatore CS8156, "Non è possibile usare un'espressione in questo contesto perché non può essere restituita per riferimento".</span><span class="sxs-lookup"><span data-stu-id="bffc3-129">Violating this rule generates compiler error CS8156, "An expression cannot be used in this context because it may not be returned by reference."</span></span>

<span data-ttu-id="bffc3-130">Inoltre, i valori restituiti di riferimento non sono consentiti per i metodi asincroni.</span><span class="sxs-lookup"><span data-stu-id="bffc3-130">In addition, reference return values are not allowed on async methods.</span></span> <span data-ttu-id="bffc3-131">Un metodo asincrono può restituire il controllo prima del termine dell'esecuzione, quando il valore restituito è ancora sconosciuto.</span><span class="sxs-lookup"><span data-stu-id="bffc3-131">An asynchronous method may return before it has finished execution, while its return value is still unknown.</span></span>

## <a name="defining-a-ref-return-value"></a><span data-ttu-id="bffc3-132">Definizione di un valore restituito ref</span><span class="sxs-lookup"><span data-stu-id="bffc3-132">Defining a ref return value</span></span>

<span data-ttu-id="bffc3-133">Un metodo che restituisce un *valore restituito di riferimento* deve soddisfare le due condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="bffc3-133">A method that returns a *reference return value* must satisfy the following two conditions:</span></span>

- <span data-ttu-id="bffc3-134">La firma del metodo include la parola chiave [ref](../../language-reference/keywords/ref.md) davanti al tipo restituito.</span><span class="sxs-lookup"><span data-stu-id="bffc3-134">The method signature includes the [ref](../../language-reference/keywords/ref.md) keyword in front of the return type.</span></span>
- <span data-ttu-id="bffc3-135">Ogni istruzione [return](../../language-reference/keywords/return.md) nel corpo del metodo include la parola chiave [ref](../../language-reference/keywords/ref.md) davanti al nome dell'istanza restituita.</span><span class="sxs-lookup"><span data-stu-id="bffc3-135">Each [return](../../language-reference/keywords/return.md) statement in the method body includes the [ref](../../language-reference/keywords/ref.md) keyword in front of the name of the returned instance.</span></span>

<span data-ttu-id="bffc3-136">L'esempio seguente illustra un metodo che soddisfa le condizioni e restituisce un riferimento a un oggetto `Person` denominato `p`:</span><span class="sxs-lookup"><span data-stu-id="bffc3-136">The following example shows a method that satisfies those conditions and returns a reference to a `Person` object named `p`:</span></span>

```csharp
public ref Person GetContactInformation(string fname, string lname)
{
    // ...method implementation...
    return ref p;
}
```

## <a name="consuming-a-ref-return-value"></a><span data-ttu-id="bffc3-137">Uso di un valore restituito ref</span><span class="sxs-lookup"><span data-stu-id="bffc3-137">Consuming a ref return value</span></span>

<span data-ttu-id="bffc3-138">Il valore restituito ref è un alias per un'altra variabile nell'ambito del metodo chiamato.</span><span class="sxs-lookup"><span data-stu-id="bffc3-138">The ref return value is an alias to another variable in the called method's scope.</span></span> <span data-ttu-id="bffc3-139">È possibile interpretare qualsiasi uso del valore restituito ref come uso della variabile di cui effettua l'aliasing:</span><span class="sxs-lookup"><span data-stu-id="bffc3-139">You can interpret any use of the ref return as using the variable it aliases:</span></span>

- <span data-ttu-id="bffc3-140">Quando si assegna il valore, si assegna un valore alla variabile di cui effettua l'aliasing.</span><span class="sxs-lookup"><span data-stu-id="bffc3-140">When you assign its value, you are assigning a value to the variable it aliases.</span></span>
- <span data-ttu-id="bffc3-141">Quando si legge il valore, si legge il valore della variabile di cui effettua l'aliasing.</span><span class="sxs-lookup"><span data-stu-id="bffc3-141">When you read its value, you are reading the value of the variable it aliases.</span></span>
- <span data-ttu-id="bffc3-142">Se lo si restituisce *per riferimento*, si restituisce un alias alla stessa variabile.</span><span class="sxs-lookup"><span data-stu-id="bffc3-142">If you return it *by reference*, you are returning an alias to that same variable.</span></span>
- <span data-ttu-id="bffc3-143">Se lo si passa a un altro metodo *per riferimento*, si passa un riferimento alla variabile di cui effettua l'aliasing.</span><span class="sxs-lookup"><span data-stu-id="bffc3-143">If you pass it to another method *by reference*, you are passing a reference to the variable it aliases.</span></span>
- <span data-ttu-id="bffc3-144">Quando si crea un alias [locale ref](#ref-locals), si crea un nuovo alias per la stessa variabile.</span><span class="sxs-lookup"><span data-stu-id="bffc3-144">When you make a [ref local](#ref-locals) alias, you make a new alias to the same variable.</span></span>

## <a name="ref-locals"></a><span data-ttu-id="bffc3-145">Variabili locali ref</span><span class="sxs-lookup"><span data-stu-id="bffc3-145">Ref locals</span></span>

<span data-ttu-id="bffc3-146">Si supponga che il metodo `GetContactInformation` venga dichiarato come valore restituito ref:</span><span class="sxs-lookup"><span data-stu-id="bffc3-146">Assume the `GetContactInformation` method is declared as a ref return:</span></span>

```csharp
public ref Person GetContactInformation(string fname, string lname)
```

<span data-ttu-id="bffc3-147">Un'assegnazione per valore legge il valore di una variabile e la assegna a una nuova variabile:</span><span class="sxs-lookup"><span data-stu-id="bffc3-147">A by-value assignment reads the value of a variable and assigns it to a new variable:</span></span>

```csharp
Person p = contacts.GetContactInformation("Brandie", "Best");
```

<span data-ttu-id="bffc3-148">L'assegnazione precedente dichiara `p` come variabile locale.</span><span class="sxs-lookup"><span data-stu-id="bffc3-148">The preceding assignment declares `p` as a local variable.</span></span> <span data-ttu-id="bffc3-149">Il valore iniziale viene copiato dalla lettura del valore restituito da `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-149">Its initial value is copied from reading the value returned by `GetContactInformation`.</span></span> <span data-ttu-id="bffc3-150">Eventuali assegnazioni future a `p` non modificheranno il valore della variabile restituita da `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-150">Any future assignments to `p` will not change the value of the variable returned by `GetContactInformation`.</span></span> <span data-ttu-id="bffc3-151">La variabile `p` non è più un alias per la variabile restituita.</span><span class="sxs-lookup"><span data-stu-id="bffc3-151">The variable `p` is no longer an alias to the variable returned.</span></span>

<span data-ttu-id="bffc3-152">Si dichiara una variabile *locale ref* per copiare l'alias nel valore originale.</span><span class="sxs-lookup"><span data-stu-id="bffc3-152">You declare a *ref local* variable to copy the alias to the original value.</span></span> <span data-ttu-id="bffc3-153">Nell'assegnazione seguente `p` è un alias per la variabile restituita da `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-153">In the following assignment, `p` is an alias to the variable returned from `GetContactInformation`.</span></span>

```csharp
ref Person p = ref contacts.GetContactInformation("Brandie", "Best");
```

<span data-ttu-id="bffc3-154">L'utilizzo successivo di `p` è uguale all'utilizzo della variabile restituita da `GetContactInformation` perché `p` è un alias per tale variabile.</span><span class="sxs-lookup"><span data-stu-id="bffc3-154">Subsequent usage of `p` is the same as using the variable returned by `GetContactInformation` because `p` is an alias for that variable.</span></span> <span data-ttu-id="bffc3-155">Le modifiche apportate a `p` modificano anche la variabile restituita da `GetContactInformation`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-155">Changes to `p` also change the variable returned from `GetContactInformation`.</span></span>

<span data-ttu-id="bffc3-156">La parola chiave `ref` viene usata sia prima della dichiarazione di variabile locale *che* prima della chiamata al metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-156">The `ref` keyword is used both before the local variable declaration *and* before the method call.</span></span>

<span data-ttu-id="bffc3-157">È possibile accedere a un valore per riferimento nello stesso modo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-157">You can access a value by reference in the same way.</span></span> <span data-ttu-id="bffc3-158">In alcuni casi, l'accesso a un valore per riferimento migliora le prestazioni evitando un'operazione di copia potenzialmente dispendiosa.</span><span class="sxs-lookup"><span data-stu-id="bffc3-158">In some cases, accessing a value by reference increases performance by avoiding a potentially expensive copy operation.</span></span> <span data-ttu-id="bffc3-159">L'istruzione seguente, ad esempio, spiega come sia possibile definire un valore locale di riferimento usato per fare riferimento a un valore.</span><span class="sxs-lookup"><span data-stu-id="bffc3-159">For example, the following statement shows how one can define a ref local value that is used to reference a value.</span></span>

```csharp
ref VeryLargeStruct reflocal = ref veryLargeStruct;
```

<span data-ttu-id="bffc3-160">La parola chiave `ref` viene usata sia prima della dichiarazione di variabile locale *che* prima del valore nel secondo esempio.</span><span class="sxs-lookup"><span data-stu-id="bffc3-160">The `ref` keyword is used both before the local variable declaration *and* before the value in the second example.</span></span> <span data-ttu-id="bffc3-161">Se non si includono entrambe le parole chiave `ref` nella dichiarazione di variabile e nell'assegnazione nei due esempi, viene generato l'errore del compilatore CS8172, "Non è possibile inizializzare una variabile per riferimento con un valore".</span><span class="sxs-lookup"><span data-stu-id="bffc3-161">Failure to include both `ref` keywords in the variable declaration and assignment in both examples results in compiler error CS8172, "Cannot initialize a by-reference variable with a value."</span></span>

<span data-ttu-id="bffc3-162">Prima di C# 7.3, le variabili locali di riferimento non potevano essere riassegnate per fare riferimento a una risorsa di archiviazione diversa dopo l'inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="bffc3-162">Prior to C# 7.3, ref local variables couldn't be reassigned to refer to different storage after being initialized.</span></span> <span data-ttu-id="bffc3-163">Questa restrizione è stata rimossa.</span><span class="sxs-lookup"><span data-stu-id="bffc3-163">That restriction has been removed.</span></span> <span data-ttu-id="bffc3-164">L'esempio seguente mostra una riassegnazione:</span><span class="sxs-lookup"><span data-stu-id="bffc3-164">The following example shows a reassignment:</span></span>

```csharp
ref VeryLargeStruct reflocal = ref veryLargeStruct; // initialization
refLocal = ref anotherVeryLargeStruct; // reassigned, refLocal refers to different storage.
```

 <span data-ttu-id="bffc3-165">Le variabili locali di riferimento devono ancora essere inizializzate quando vengono dichiarate.</span><span class="sxs-lookup"><span data-stu-id="bffc3-165">Ref local variables must still be initialized when they are declared.</span></span>

## <a name="ref-returns-and-ref-locals-an-example"></a><span data-ttu-id="bffc3-166">Valori restituiti e variabili locali ref: un esempio</span><span class="sxs-lookup"><span data-stu-id="bffc3-166">Ref returns and ref locals: an example</span></span>

<span data-ttu-id="bffc3-167">L'esempio seguente definisce una classe `NumberStore` che archivia una matrice di valori integer.</span><span class="sxs-lookup"><span data-stu-id="bffc3-167">The following example defines a `NumberStore` class that stores an array of integer values.</span></span> <span data-ttu-id="bffc3-168">Il metodo `FindNumber` restituisce per riferimento il primo numero maggiore o uguale al numero passato come argomento.</span><span class="sxs-lookup"><span data-stu-id="bffc3-168">The `FindNumber` method returns by reference the first number that is greater than or equal to the number passed as an argument.</span></span> <span data-ttu-id="bffc3-169">Se nessun numero è maggiore o uguale all'argomento, il metodo restituisce il numero nell'indice 0.</span><span class="sxs-lookup"><span data-stu-id="bffc3-169">If no number is greater than or equal to the argument, the method returns the number in index 0.</span></span>

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/NumberStore.cs#1)]

<span data-ttu-id="bffc3-170">L'esempio seguente chiama il metodo `NumberStore.FindNumber` per recuperare il primo valore maggiore o uguale a 16.</span><span class="sxs-lookup"><span data-stu-id="bffc3-170">The following example calls the `NumberStore.FindNumber` method to retrieve the first value that is greater than or equal to 16.</span></span> <span data-ttu-id="bffc3-171">Il chiamante raddoppia quindi il valore restituito dal metodo.</span><span class="sxs-lookup"><span data-stu-id="bffc3-171">The caller then doubles the value returned by the method.</span></span> <span data-ttu-id="bffc3-172">L'output dell'esempio mostra la modifica riflessa nel valore degli elementi della matrice dell'istanza di `NumberStore`.</span><span class="sxs-lookup"><span data-stu-id="bffc3-172">The output from the example shows the change reflected in the value of the array elements of the `NumberStore` instance.</span></span>

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/NumberStore.cs#2)]

<span data-ttu-id="bffc3-173">Senza il supporto per i valori restituiti di riferimento, tale operazione viene eseguita restituendo l'indice dell'elemento di matrice insieme al relativo valore.</span><span class="sxs-lookup"><span data-stu-id="bffc3-173">Without support for reference return values, such an operation is performed by returning the index of the array element along with its value.</span></span> <span data-ttu-id="bffc3-174">Il chiamante può quindi usare questo indice per modificare il valore in una chiamata al metodo distinta.</span><span class="sxs-lookup"><span data-stu-id="bffc3-174">The caller can then use this index to modify the value in a separate method call.</span></span> <span data-ttu-id="bffc3-175">Il chiamante può tuttavia anche modificare l'indice per accedere ed eventualmente modificare altri valori della matrice.</span><span class="sxs-lookup"><span data-stu-id="bffc3-175">However, the caller can also modify the index to access and possibly modify other array values.</span></span>  

<span data-ttu-id="bffc3-176">L'esempio seguente illustra il modo in cui è possibile riscrivere il metodo `FindNumber` dopo C# 7.3 per usare la riassegnazione locale del riferimento:</span><span class="sxs-lookup"><span data-stu-id="bffc3-176">The following example shows how the `FindNumber` method could be rewritten after C# 7.3 to use ref local reassignment:</span></span>

[!code-csharp[ref-returns](../../../../samples/snippets/csharp/programming-guide/ref-returns/NumberStoreUpdated.cs#1)]

<span data-ttu-id="bffc3-177">Questa seconda versione è più efficiente con sequenze più lunghe negli scenari in cui il numero cercato è più vicino alla fine della matrice.</span><span class="sxs-lookup"><span data-stu-id="bffc3-177">This second version is more efficient with longer sequences in scenarios where the number sought is closer to the end of the array.</span></span>

## <a name="see-also"></a><span data-ttu-id="bffc3-178">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="bffc3-178">See also</span></span>

- [<span data-ttu-id="bffc3-179">ref (parola chiave)</span><span class="sxs-lookup"><span data-stu-id="bffc3-179">ref keyword</span></span>](../../language-reference/keywords/ref.md)
- [<span data-ttu-id="bffc3-180">Scrivere codice efficiente e sicuro</span><span class="sxs-lookup"><span data-stu-id="bffc3-180">Write safe efficient code</span></span>](../../write-safe-efficient-code.md)
